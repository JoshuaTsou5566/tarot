<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>大阿爾克納 - 塔羅占卜</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; transition: background-color 0.8s ease; margin: 0; padding: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        ::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-press:active { transform: scale(0.92); transition: transform 0.1s; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .decoration-layer { pointer-events: none; z-index: -1; }
        /* 防止手機輸入時縮放 */
        input, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-[#020617]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. SVG 圖標路徑定義 ---
        const ICONS = {
            Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></>,
            RefreshCw: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>,
            Moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>,
            Sun: <><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.11 1.11"/><path d="M19.07 4.93l-1.41 1.41"/></>,
            BookOpen: <><path d="M2 3h6a4 4 0 0 1 4 4v14a4 4 0 0 0-4-4H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a4 4 0 0 1 4-4h6z"/></>,
            Layout: <><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></>,
            Compass: <><circle cx="12" cy="12" r="10"/><path d="m16.24 7.76-2.12 6.36-6.36 2.12 2.12-6.36 6.36-2.12z"/></>,
            BrainCircuit: <><path d="M12 4.5V2"/><path d="M18 11h2.5"/><path d="M12 19.5V22"/><path d="M5.5 11H3"/><path d="M12 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/><path d="M16 12.5V11a4 4 0 0 0-8 0v1.5"/><path d="M16 8a4 4 0 0 0-8 0"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            Copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>,
            ChevronDown: <polyline points="6 9 12 15 18 9" />,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            X: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>,
            Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
            Share: <><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></>,
            AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            ChiikawaSilhouette: <path d="M12 22C6.5 22 2 18 2 12.5C2 9 4 6 7 5 V 2 A 1.5 1.5 0 0 1 11 2v2c.3-.1.6-.1.9-.1s.7 0 1 .1V2a1.5 1.5 0 0 1 3 0v2.5c3.5 1 6 4 6 7.5 0 5.5-4.5 10-10 10z" fill="currentColor" />,
            HachiwareSilhouette: <path d="M12 22c-5 0-9-4-9-9 0-3.5 2-6.5 5-7.5 L 4.5 1 L 8 0 L 10 3.5 C 10.5 3.5 11.5 3.3 12 3.3 S 13.5 3.5 14 3.5 L 16 0 L 19.5 1 L 19 5 C 21 6 22 9 22 12.5 22 18 18 22 12 22 Z M 10 9 L 12 11 L 14 9" fill="currentColor" />,
            UsagiSilhouette: <path d="M12 22c-5 0-9-4-9-9 0-4 1.5-7.5 4-8.5 V 0 a 1 1 0 0 1 2 0 v 4 c 1 -.1 2 -.2 3 -.2 s 2 .1 3 .2 v -4 a 1 1 0 0 1 2 0 v 4.5 c 2.5 1 4 4.5 4 8.5 0 5 -4 9 -9 9 Z" fill="currentColor" />
        };

        // --- 2. 基礎組件 ---
        const Icon = ({ name, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {ICONS[name] || null}
            </svg>
        );

        // --- 3. 資料定義 ---
        const TAROT_DATA = [
            { id: 0, numeral: "0", title: "愚者", meaning: "開端與冒險", uprightInsight: "全新的開始，勇敢踏出冒險的第一步。信任宇宙，前方有無限可能。" },
            { id: 1, numeral: "I", title: "魔術師", meaning: "創造與能力", uprightInsight: "你已具備成功工具，現在正是實踐想法的時刻。展現你的才華吧。" },
            { id: 2, numeral: "II", title: "女祭司", meaning: "直覺與神秘", uprightInsight: "深度連結直覺，靜待真相浮現。保持內心的寧靜與冷靜。" },
            { id: 3, numeral: "III", title: "皇后", meaning: "豐收與生命力", uprightInsight: "生命充滿恩惠與溫柔，正是享受生活與創造的時刻。" },
            { id: 4, numeral: "IV", title: "皇帝", meaning: "秩序與權威", uprightInsight: "展現領導力，建立穩定結構。這是一個掌握掌控權的時期。" },
            { id: 5, numeral: "V", title: "教皇", meaning: "知識與傳統", uprightInsight: "尋求智慧引導，遵循正統價值。適合向專業人士諮詢。" },
            { id: 6, numeral: "VI", title: "戀人", meaning: "祝福與契合", uprightInsight: "完美契合的關係，面臨忠於心靈的選擇。信任你的心。" },
            { id: 7, numeral: "VII", title: "戰車", meaning: "意志與勝利", uprightInsight: "意志堅定，以行動力克服困難。這是一場必定勝利的遠征。" },
            { id: 8, numeral: "VIII", title: "力量", meaning: "勇氣與堅韌", uprightInsight: "以柔克剛，展現內在不屈的慈悲與強韌。你比想像中更強大。" },
            { id: 9, numeral: "IX", title: "隱者", meaning: "內省與智慧", uprightInsight: "向內探索，在孤獨中遇見真實的自我。你需要一段寧靜的時光。" },
            { id: 10, numeral: "X", title: "命運之輪", meaning: "週期與轉機", uprightInsight: "轉機降臨，命運齒輪正帶領你前進。接受變動與好運。" },
            { id: 11, numeral: "XI", title: "正義", meaning: "公平與客觀", uprightInsight: "誠實無私，事物朝向平衡發展。真相將會大白。" },
            { id: 12, numeral: "XII", title: "倒吊人", meaning: "犧牲與覺醒", uprightInsight: "換個角度看世界。暫時的靜止是為了換取更高的覺醒。" },
            { id: 13, numeral: "XIII", title: "死神", meaning: "終結與轉化", uprightInsight: "捨棄舊模式，迎接新生。結束是另一個偉大開始的序幕。" },
            { id: 14, numeral: "XIV", title: "節制", meaning: "平衡與調和", uprightInsight: "融合不同元素，保持平和。事物正以和諧的節奏趨於完美。" },
            { id: 15, numeral: "XV", title: "惡魔", meaning: "慾望與制約", uprightInsight: "覺察束縛你的物質執迷。意識到問題是解脫的第一步。" },
            { id: 16, numeral: "XVI", title: "塔", meaning: "劇變與啟示", uprightInsight: "劇烈瓦解虛偽，真相在廢墟中顯現。這是一個必要的重整。" },
            { id: 17, numeral: "XVII", title: "星星", meaning: "希望與療癒", uprightInsight: "希望湧現，心靈獲得寧靜療癒。跟隨那道引導的光芒。" },
            { id: 18, numeral: "XVIII", title: "月亮", meaning: "不安與潛意識", uprightInsight: "警惕幻覺，傾聽潛意識引導。真相隱藏在迷霧之後。" },
            { id: 19, numeral: "XIX", title: "太陽", meaning: "光明與成功", uprightInsight: "成功在望，喜悅圓滿。這是一個充滿活力與榮耀的時刻。" },
            { id: 20, numeral: "XX", title: "審判", meaning: "復活與感召", uprightInsight: "靈魂覺醒，原諒過去。這是一個邁向生命新階段的時刻。" },
            { id: 21, numeral: "XXI", title: "世界", meaning: "完美與圓滿", uprightInsight: "旅程功德圓滿，完美的整合。祝賀你達成心願。" }
        ];

        const CHIIKAWA_IMAGES = {
            0: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/0.jpg",
            1: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/1.jpg",
            2: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/2.jpg",
            3: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/3.jpg",
            4: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/4.jpg",
            5: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/5.jpg",
            6: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/6.jpg",
            7: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/7.jpg",
            8: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/8.jpg",
            9: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/9.jpg",
            10: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/10.jpg",
            11: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/11.jpg",
            12: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/12.jpg",
            13: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/13.jpg",
            14: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/14.jpg",
            15: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/15.jpg",
            16: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/16.jpg",
            17: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/17.jpg",
            18: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/18.jpg",
            19: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/19.jpg",
            20: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/20.jpg",
            21: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/21.jpg"
        };

        // --- 4. 分離的卡牌組件 ---
        const TarotView = ({card, idx, isChiMode, theme}) => (
            <div key={idx} className="flex flex-col items-center gap-3 animate-in" style={{animationDelay: `${idx*150}ms`}}>
                <div className={`relative w-44 h-72 rounded-xl p-0.5 bg-gradient-to-br from-white/80 to-white/20 shadow-2xl ${card.isReversed ? 'rotate-180' : ''}`}>
                    <div className={`w-full h-full ${theme.cardBg} rounded-lg flex flex-col items-center justify-between relative overflow-hidden transition-colors duration-1000`}>
                        <div className="absolute top-2 left-3 text-[10px] opacity-30 font-serif z-10">{card.numeral}</div>
                        <div className="flex-1 w-full relative group">
                            {isChiMode ? (
                                <div className="w-full h-full flex items-center justify-center p-2"><img src={CHIIKAWA_IMAGES[card.id]} className="w-full h-full object-contain opacity-90" alt={card.title} /></div>
                            ) : (
                                <div className="w-full h-full flex flex-col items-center justify-center space-y-3 pt-6 transition-colors duration-1000"><Icon name={card.id === 19 ? "Sun" : (card.id === 18 ? "Moon" : "Star")} size={48} className="opacity-40" /><div className="text-center font-bold tracking-widest transition-colors duration-1000">{card.title}</div></div>
                            )}
                        </div>
                        <div className={`w-full py-2 px-3 text-center z-10 ${isChiMode ? 'bg-black/60 backdrop-blur-md' : ''}`}>
                            {isChiMode && <div className="text-[11px] font-bold tracking-widest text-white">{card.title}</div>}
                            <div className={`text-[8px] uppercase font-mono tracking-tighter ${isChiMode ? 'text-white/50' : 'opacity-20'}`}>TAROT ORACLE</div>
                        </div>
                    </div>
                </div>
                <span className="text-[10px] uppercase opacity-60 font-bold tracking-widest">{card.isReversed ? '逆位' : '正位'}</span>
            </div>
        );

        // --- 5. 主程式 ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('divination');
            const [theme, setTheme] = useState('night');
            const [gameState, setGameState] = useState('idle');
            const [spreadType, setSpreadType] = useState('one');
            const [userQuestion, setUserQuestion] = useState('');
            const [selectedCards, setSelectedCards] = useState([]);
            const [aiResponse, setAiResponse] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [secretClickCount, setSecretClickCount] = useState(0);
            
            const [isKeySetupVisible, setIsKeySetupVisible] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isUnlocking, setIsUnlocking] = useState(false);
            const [unlockPassInput, setUnlockPassInput] = useState('');
            const [masterKeyInput, setMasterKeyInput] = useState('');
            const [masterPasscodeInput, setMasterPasscodeInput] = useState('');
            const [masterFbConfigInput, setMasterFbConfigInput] = useState('');
            const [zoomedImage, setZoomedImage] = useState(null);
            const [message, setMessage] = useState(null);
            
            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appId = 'arcanum-divination';

            // 智慧解析器
            const extractFirebaseConfig = (input) => {
                if (!input) return null;
                const config = {};
                const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId', 'measurementId'];
                keys.forEach(key => {
                    const regex = new RegExp(`${key}\\s*[:=]\\s*["']([^"']+)["']`);
                    const match = input.match(regex);
                    if (match) config[key] = match[1];
                });
                return (config.apiKey && config.projectId) ? config : null;
            };

            const initFirebase = async (config) => {
                try {
                    if (firebase.apps.length > 0) await firebase.app().delete();
                    firebase.initializeApp(config);
                    dbRef.current = firebase.firestore();
                    authRef.current = firebase.auth();
                    return true;
                } catch (e) { return false; }
            };

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedConfig = urlParams.get('c');
                if (encodedConfig) {
                  try {
                    const configStr = atob(encodedConfig);
                    localStorage.setItem('arcanum_fb_config', configStr);
                    window.history.replaceState({}, document.title, window.location.pathname);
                  } catch(e) {}
                }
                const rawConfig = localStorage.getItem('arcanum_fb_config');
                if (rawConfig) {
                    const config = extractFirebaseConfig(rawConfig);
                    if (config) initFirebase(config);
                }
            }, []);

            const handleSecretClick = () => {
                const nextCount = secretClickCount + 1;
                if (nextCount >= 5) { setTheme('chiikawa-pink'); setSecretClickCount(0); }
                else { setSecretClickCount(nextCount); }
            };

            const toggleTheme = () => {
                if (theme === 'chiikawa-pink') setTheme('chiikawa-blue');
                else if (theme === 'chiikawa-blue') setTheme('chiikawa-yellow');
                else if (theme === 'chiikawa-yellow') setTheme('chiikawa-pink');
                else setTheme(prev => prev === 'night' ? 'day' : 'night');
            };

            const returnToClassic = () => setTheme('night');
            const isChiikawa = theme.startsWith('chiikawa');

            const themeStyles = useMemo(() => {
                const styles = {
                    night: { bg: "bg-[#020617]", text: "text-slate-100", secondaryText: "text-slate-400", glow1: "bg-indigo-900", glow2: "bg-purple-900", navBg: "bg-slate-900/80", cardBg: "bg-slate-900", btnBg: "bg-white text-slate-950", panelBg: "bg-slate-900/60", border: "border-white/10", activeBtn: "border-white bg-white/20 shadow-lg", accent: "#818cf8" },
                    day: { bg: "bg-[#fffbeb]", text: "text-slate-800", secondaryText: "text-slate-500", glow1: "bg-amber-200", glow2: "bg-orange-200", navBg: "bg-white/80", cardBg: "bg-white", btnBg: "bg-slate-900 text-white", panelBg: "bg-white/80", border: "border-amber-900/10", activeBtn: "border-slate-800 bg-slate-800 text-white", accent: "#ea580c" },
                    'chiikawa-pink': { bg: "bg-[#EFA5C9]", text: "text-[#5D2E46]", secondaryText: "text-[#8E4A6E]", glow1: "bg-white/40", glow2: "bg-[#FADDE9]", navBg: "bg-white/70", cardBg: "bg-white", btnBg: "bg-[#D64E8B] text-white shadow-lg", activeBtn: "bg-[#D64E8B] border-[#D64E8B] text-white", panelBg: "bg-[#FFF0F6]/95", border: "border-[#F4C1D9]", accent: "#D64E8B" },
                    'chiikawa-blue': { bg: "bg-[#91A8D0]", text: "text-[#1B2A4E]", secondaryText: "text-[#3D5A80]", glow1: "bg-white/40", glow2: "bg-[#D1DCEE]", navBg: "bg-white/70", cardBg: "bg-white", btnBg: "bg-[#3D5A80] text-white shadow-lg", activeBtn: "bg-[#3D5A80] border-[#3D5A80] text-white", panelBg: "bg-[#E8EEF8]/95", border: "border-[#B8C9E5]", accent: "#3D5A80" },
                    'chiikawa-yellow': { bg: "bg-[#FFF9D4]", text: "text-[#4D432A]", secondaryText: "text-[#7A6F44]", glow1: "bg-white/50", glow2: "bg-[#FEF5BC]", navBg: "bg-white/70", cardBg: "bg-white", btnBg: "bg-[#96831A] text-white", activeBtn: "bg-[#96831A] border-[#96831A] text-white", panelBg: "bg-[#FFFEF2]/95", border: "border-[#E8DE95]", accent: "#96831A" }
                };
                return styles[theme];
            }, [theme]);

            const fetchAiInterpretation = async (question, cards, type, key) => {
                setIsAiLoading(true); setAiResponse('');
                const cardDetails = cards.map((c, i) => `${type === 'triangle' ? ['過去','現在','未來'][i] : '核心建議'}: ${c.title}(${c.isReversed ? '逆位' : '正位'}) - ${c.meaning}`).join('\n');
                const prompt = `你是一位專業塔羅大師。問題：${question || '當前指引'}。牌組：\n${cardDetails}\n\n請給予 300 字深度解讀。語氣溫暖有力。嚴禁使用 Markdown。`;
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    setAiResponse((data.candidates?.[0]?.content?.parts?.[0]?.text || "").replace(/[*#]/g, '').trim());
                } catch (e) { setMessage({text: "API 解析失敗：" + e.message, type: 'error'}); } 
                finally { setIsAiLoading(false); }
            };

            const drawCards = () => {
                setIsAuthenticated(false); setAiResponse(''); setUnlockPassInput(''); setGameState('shuffling');
                setTimeout(() => {
                    const count = spreadType === 'one' ? 1 : 3;
                    const drawn = [...TAROT_DATA].sort(() => Math.random() - 0.5).slice(0, count).map(card => ({
                        ...card, isReversed: Math.random() > 0.35, timestamp: new Date().toLocaleTimeString()
                    }));
                    setSelectedCards(drawn); setGameState('revealed');
                }, 2000);
            };

            const handleUnlockInterpretation = async () => {
                if (!dbRef.current || !authRef.current) { 
                    setMessage({text: "裝置未連線。請管理員點開「親友授權連結」完成同步。", type: 'error'});
                    return; 
                }
                setIsUnlocking(true);
                try {
                  await authRef.current.signInAnonymously();
                  const path = `/artifacts/${appId}/public/data/config`;
                  const configDoc = await dbRef.current.doc(`${path}/settings`).get();
                  if (!configDoc.exists) { setMessage({text: "雲端尚未設定。請管理員在原始裝置初始化。", type: 'error'}); return; }
                  const { apiKey: cloudKey, password: cloudPass } = configDoc.data();
                  if (unlockPassInput.trim() === cloudPass) {
                      setIsAuthenticated(true); fetchAiInterpretation(userQuestion, selectedCards, spreadType, cloudKey);
                  } else { setMessage({text: "密碼不正確。", type: 'error'}); }
                } catch (err) { 
                    setMessage({text: "連線失敗。請確認 Firebase 後台已啟用 Anonymous 登入。", type: 'error'});
                }
                finally { setIsUnlocking(false); }
            };

            const handleSetup = async () => {
                const key = masterKeyInput.trim(); const pass = masterPasscodeInput.trim(); const fbInput = masterFbConfigInput.trim();
                if (fbInput) {
                    const config = extractFirebaseConfig(fbInput);
                    if (config) {
                        const ok = await initFirebase(config);
                        if (ok) localStorage.setItem('arcanum_fb_config', fbInput);
                    } else { setMessage({text: "配置提取失敗。", type: 'error'}); return; }
                }
                if (!dbRef.current || !authRef.current) { setMessage({text: "尚未建立 Firebase 連線。", type: 'error'}); return; }
                try {
                  await authRef.current.signInAnonymously();
                  const path = `/artifacts/${appId}/public/data/config`;
                  await dbRef.current.doc(`${path}/settings`).set({ apiKey: key, password: pass, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                  setIsKeySetupVisible(false); setMessage({text: "雲端同步成功！", type: 'success'});
                } catch (e) { setMessage({text: "存儲失敗：" + e.message, type: 'error'}); }
            };

            const generateShareLink = () => {
              const rawConfig = localStorage.getItem('arcanum_fb_config');
              if (!rawConfig) { setMessage({text: "請先完成雲端配置。", type: 'error'}); return; }
              const shareUrl = `${window.location.origin}${window.location.pathname}?c=${btoa(rawConfig)}`;
              const textArea = document.createElement("textarea"); textArea.value = shareUrl;
              document.body.appendChild(textArea); textArea.select();
              document.execCommand('copy'); document.body.removeChild(textArea);
              setMessage({text: "授權連結已複製！傳給手機開啟即可連線。", type: 'success'});
            };

            const MessageModal = () => (
                message && (
                    <div className="fixed inset-0 z-[300] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm animate-in no-select">
                        <div className="w-full max-w-xs bg-slate-900 border border-white/10 rounded-[2rem] p-8 space-y-6 shadow-2xl text-center">
                            <div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center bg-white/5`}>
                                <Icon name="AlertCircle" className={message.type === 'error' ? 'text-rose-400' : 'text-emerald-400'} />
                            </div>
                            <p className="text-sm text-white/80 leading-relaxed">{message.text}</p>
                            <button onClick={() => setMessage(null)} className="w-full py-3 bg-white text-slate-900 rounded-full font-bold text-xs tracking-widest shadow-xl">確定</button>
                        </div>
                    </div>
                )
            );

            const GuidePage = () => {
                const [expandedId, setExpandedId] = useState(null);
                return (
                    <div className="animate-in space-y-8 pb-10">
                        <h2 className="text-3xl font-serif font-bold tracking-widest transition-colors duration-1000">占卜指南</h2>
                        <div className="space-y-4">
                            <div className="glass-panel p-6 rounded-[2rem]">
                                <p className="font-bold text-indigo-400 mb-2 font-serif tracking-widest uppercase text-sm">Cloud Share</p>
                                <p className="text-[11px] opacity-70 leading-relaxed text-justify italic">若要在其他裝置使用，點擊下方生成「授權連結」傳給親友。點開後他們即可連線您的雲端，無須重設金鑰。</p>
                                <button onClick={generateShareLink} className="mt-4 flex items-center gap-2 px-5 py-2.5 bg-indigo-500/20 border border-indigo-500/30 rounded-full text-[10px] font-bold active:scale-95 transition-all"><Icon name="Share" size={12} /> 生成親友授權連結</button>
                            </div>
                        </div>
                        <div className="space-y-8">
                            <section className="space-y-4">
                                <h3 className="font-bold text-lg opacity-80 border-l-4 border-rose-500 pl-3">大阿爾克那圖鑑</h3>
                                <div className="space-y-2">
                                    {TAROT_DATA.map(c => (
                                        <div key={c.id} className="border border-white/5 rounded-2xl overflow-hidden glass-panel">
                                            <button onClick={() => setExpandedId(expandedId === c.id ? null : c.id)} className="w-full flex items-center justify-between p-5 text-left transition-colors hover:bg-white/5">
                                                <div className="flex items-center gap-4"><span className="font-mono text-xs opacity-40">{c.numeral}</span><span className="font-bold tracking-widest">{c.title}</span></div>
                                                <Icon name="ChevronDown" size={16} className={`transition-transform ${expandedId === c.id ? 'rotate-180' : ''}`} />
                                            </button>
                                            {expandedId === c.id && (
                                                <div className="p-6 bg-black/20 text-xs space-y-4 animate-in text-justify">
                                                    <p className="opacity-60 italic leading-relaxed">{c.uprightInsight}</p>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </section>
                            <button onClick={() => setIsKeySetupVisible(true)} className="w-full py-4 border border-dashed border-white/20 rounded-2xl opacity-40 text-xs hover:opacity-100 transition-all font-bold uppercase tracking-[0.2em]">管理員雲端設定</button>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen ${themeStyles.bg} ${themeStyles.text} transition-colors duration-1000 pb-24 relative`}>
                    <MessageModal />
                    <div className="decoration-layer fixed inset-0 overflow-hidden opacity-20">
                        <div className={`absolute top-[-10%] left-[-10%] w-[80%] h-[40%] ${themeStyles.glow1} rounded-full blur-[120px] transition-colors duration-1000`} />
                        <div className={`absolute bottom-[-10%] right-[-10%] w-[80%] h-[40%] ${themeStyles.glow2} rounded-full blur-[120px] transition-colors duration-1000`} />
                    </div>

                    {isKeySetupVisible && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/95 backdrop-blur-md animate-in no-select">
                            <div className="w-full max-w-sm glass-panel rounded-[3.5rem] p-10 space-y-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                                <div className="text-center space-y-2"><h3 className="text-2xl font-serif font-bold transition-colors duration-1000">雲端初始化</h3><p className="text-[10px] opacity-50 italic text-indigo-300">連線後任何裝置輸入密碼即可解鎖結果</p></div>
                                <div className="space-y-4 text-left">
                                    <div className="space-y-1"><label className="text-[10px] opacity-40 ml-2 uppercase font-bold tracking-widest">Gemini API Key</label><input type="password" value={masterKeyInput} onChange={e=>setMasterKeyInput(e.target.value)} placeholder="API Key" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-indigo-400 shadow-inner" /></div>
                                    <div className="space-y-1"><label className="text-[10px] opacity-40 ml-2 uppercase font-bold tracking-widest">解鎖密碼</label><input type="text" value={masterPasscodeInput} onChange={e=>setMasterPasscodeInput(e.target.value)} placeholder="解鎖密碼" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-indigo-400 shadow-inner" /></div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] opacity-40 ml-2 uppercase font-bold tracking-widest">Firebase 配置</label>
                                        <textarea value={masterFbConfigInput} onChange={e=>setMasterFbConfigInput(e.target.value)} placeholder='直接貼入 Firebase 控制台代碼片段' className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-[10px] h-32 focus:outline-none focus:border-indigo-400 font-mono shadow-inner" />
                                    </div>
                                </div>
                                <button onClick={handleSetup} className="w-full py-5 bg-white text-slate-900 rounded-full font-bold text-sm shadow-xl active:scale-95 transition-all">同步並儲存雲端</button>
                                <button onClick={() => setIsKeySetupVisible(false)} className="w-full text-[10px] opacity-30 mt-4 font-bold tracking-widest uppercase text-center">取消</button>
                            </div>
                        </div>
                    )}

                    <div className="relative z-10 max-lg mx-auto px-6 py-8 pb-32">
                        <header className="flex justify-between items-center mb-10 animate-in transition-colors duration-1000">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={handleSecretClick}>
                                <div className="p-2 rounded-xl bg-white/20 transition-colors"><Icon name={isChiikawa ? "Heart" : "Sparkles"} className={isChiikawa ? "animate-pulse text-white" : "text-amber-300"} /></div>
                                <h1 className="text-xl font-serif font-bold tracking-widest transition-colors duration-1000">
                                    {isChiikawa ? '阿爾克納 & Chiikawa' : '大阿爾克納 - 塔羅占卜'}
                                </h1>
                            </div>
                            <div className="flex gap-2">
                                {isChiikawa && <button onClick={returnToClassic} className="w-10 h-10 rounded-full flex items-center justify-center border bg-white/10 shadow-sm btn-press transition-all"><Icon name="LogOut" size={16} /></button>}
                                <button onClick={toggleTheme} className="w-12 h-12 rounded-full flex items-center justify-center border bg-white/10 shadow-sm btn-press transition-all">
                                    {theme === 'chiikawa-pink' ? <Icon name="ChiikawaSilhouette" size={28} /> :
                                     theme === 'chiikawa-blue' ? <Icon name="HachiwareSilhouette" size={28} /> :
                                     theme === 'chiikawa-yellow' ? <Icon name="UsagiSilhouette" size={28} /> :
                                     (theme === 'night' ? <Icon name="Moon" size={20} /> : <Icon name="Sun" size={20} />)}
                                </button>
                            </div>
                        </header>

                        {activeTab === 'divination' && (
                            <div className="animate-in transition-colors duration-1000">
                                {gameState === 'idle' && (
                                    <div className="space-y-8">
                                        <h2 className="text-4xl font-serif font-bold leading-tight transition-colors duration-1000">{isChiikawa ? '嘿！現在\n想問什麼？' : '現在\n你想問什麼？'}</h2>
                                        <textarea value={userQuestion} onChange={e => setUserQuestion(e.target.value)} placeholder="在此輸入您的問題..." className="w-full h-36 border border-white/10 bg-white/5 rounded-3xl p-6 focus:outline-none transition-all resize-none shadow-xl text-lg placeholder:opacity-30" />
                                        <div className="flex gap-4">
                                            <button onClick={() => setSpreadType('one')} className={`flex-1 p-5 rounded-3xl border-2 transition-all group btn-press ${spreadType === 'one' ? themeStyles.activeBtn : 'border-white/5 bg-white/5 opacity-40'}`}><Icon name="Compass" size={24} className="mx-auto mb-2 opacity-50" /><span className="text-sm font-bold block uppercase tracking-widest">一牌直覺</span></button>
                                            <button onClick={() => setSpreadType('triangle')} className={`flex-1 p-5 rounded-3xl border-2 transition-all group btn-press ${spreadType === 'triangle' ? themeStyles.activeBtn : 'border-white/5 bg-white/5 opacity-40'}`}><Icon name="Layout" size={24} className="mx-auto mb-2 opacity-50" /><span className="text-sm font-bold block uppercase tracking-widest">聖三角</span></button>
                                        </div>
                                        <button onClick={drawCards} className={`w-full py-6 ${themeStyles.btnBg} rounded-full font-bold tracking-[0.3em] btn-press shadow-2xl uppercase text-lg transition-colors duration-1000`}>啟動靈性感應</button>
                                    </div>
                                )}

                                {gameState === 'revealed' && (
                                    <div className="space-y-10 animate-in transition-colors duration-1000">
                                        <div className="flex flex-wrap justify-center gap-6">
                                            {selectedCards.map((c, i) => (
                                                 <TarotView key={i} card={c} idx={i} isChiMode={isChiikawa} theme={themeStyles} />
                                            ))}
                                        </div>
                                        <div className="space-y-6 pb-20">
                                            <div className="glass-panel rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden transition-colors duration-1000 min-h-[350px]">
                                                <div className="flex items-center gap-3 mb-6 opacity-60 font-bold tracking-widest uppercase transition-colors duration-1000"><Icon name="BrainCircuit" size={20} />宇宙的深層啟示</div>
                                                {isAiLoading ? (<div className="flex flex-col items-center justify-center py-20 gap-4 text-center transition-colors duration-1000"><Icon name="RefreshCw" className="animate-spin opacity-30" size={32} /><p className="animate-pulse text-sm opacity-40 tracking-widest font-serif">正在感應能量...</p></div>) : aiResponse ? (
                                                    <div className="leading-relaxed font-light text-justify whitespace-pre-wrap text-base animate-in transition-colors duration-1000">{aiResponse}</div>
                                                ) : !isAuthenticated ? (
                                                    <div className="py-10 flex flex-col items-center gap-6 animate-in transition-colors duration-1000">
                                                        <Icon name="Lock" size={40} className="opacity-20" />
                                                        <div className="text-center space-y-2 mb-4"><p className="text-sm opacity-50 font-light tracking-wide transition-colors duration-1000">啟示已加密鎖定</p><p className="text-[10px] opacity-30 uppercase tracking-[0.2em] transition-colors duration-1000">請輸入解鎖密碼</p></div>
                                                        <div className="flex flex-col w-full gap-5 px-4 max-w-xs mb-10 pb-16">
                                                            <input type="text" value={unlockPassInput} onChange={e=>setUnlockPassInput(e.target.value)} placeholder="訪問密碼" className="w-full bg-white/5 border border-white/10 rounded-xl p-5 text-center text-sm focus:outline-none focus:border-indigo-400 shadow-inner" />
                                                            <button onClick={handleUnlockInterpretation} disabled={isUnlocking} className="w-full py-5 bg-white text-slate-900 rounded-xl font-bold text-xs btn-press shadow-xl active:bg-indigo-50 tracking-widest uppercase transition-all disabled:opacity-50">
                                                                {isUnlocking ? "正在連線..." : "解鎖啟示內容"}
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : <div className="text-center py-20 opacity-30 italic text-sm transition-colors duration-1000">同步中...</div>}
                                            </div>
                                            {selectedCards.map((c, i) => (<div key={i} className={`p-7 rounded-[2.5rem] border ${themeStyles.border} bg-white/5 text-sm space-y-4 shadow-md transition-colors duration-1000 animate-in`} style={{animationDelay: `${i*100}ms`}}><div className="flex justify-between items-center mb-5 transition-colors duration-1000"><h4 className="font-bold flex items-center gap-2"><span className="w-1.5 h-1.5 bg-current opacity-20 rounded-full" />{c.title} 基本解析</h4></div><div className="space-y-2 opacity-80 leading-relaxed text-justify transition-colors duration-1000"><p className="font-bold">{c.meaning}</p><p className="italic opacity-60 text-xs leading-relaxed transition-colors duration-1000">{c.uprightInsight}</p></div></div>))}
                                            <div className="flex flex-col gap-5 pt-4 mb-24"><button onClick={resetGame} className={`w-full py-5 border-2 ${themeStyles.border} rounded-full text-base font-bold flex items-center justify-center gap-2 active:scale-95 transition-all uppercase tracking-widest opacity-60 transition-colors duration-1000`}><Icon name="RefreshCw" size={20} /> 重新占卜</button></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {activeTab === 'guide' && <GuidePage />}
                    </div>

                    <nav className={`fixed bottom-0 left-0 w-full ${themeStyles.navBg} backdrop-blur-2xl border-t ${themeStyles.border} px-16 py-6 flex justify-around items-center z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.2)] transition-colors duration-1000 no-select`}>
                        <button onClick={() => setActiveTab('divination')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'divination' ? 'opacity-100 scale-110' : 'opacity-100'}`} style={{color: activeTab === 'divination' ? themeStyles.accent : '#64748b'}}><Icon name="Sparkles" size={24} /><span className="text-[10px] font-bold uppercase tracking-widest mt-1">占卜</span></button>
                        <button onClick={() => setActiveTab('guide')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'guide' ? 'opacity-100 scale-110' : 'opacity-100'}`} style={{color: activeTab === 'guide' ? themeStyles.accent : '#64748b'}}><Icon name="BookOpen" size={24} /><span className="text-[10px] font-bold uppercase tracking-widest mt-1">指南</span></button>
                    </nav>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
