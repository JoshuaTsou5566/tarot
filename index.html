<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>阿爾克納 & Chiikawa - 塔羅占卜</title>
    <!-- 載入 React 核心 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 載入 Babel 編譯器 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; transition: background-color 0.8s ease; margin: 0; padding: 0; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        ::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        .btn-press:active { transform: scale(0.95); transition: transform 0.1s; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-[#020617]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- SVG 圖示定義 ---
        const ICONS = {
            Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></>,
            RefreshCw: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>,
            Moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>,
            Sun: <><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.11 1.11"/><path d="M19.07 4.93l-1.41 1.41"/></>,
            BookOpen: <><path d="M2 3h6a4 4 0 0 1 4 4v14a4 4 0 0 0-4-4H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a4 4 0 0 1 4-4h6z"/></>,
            Layout: <><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></>,
            Compass: <><circle cx="12" cy="12" r="10"/><path d="m16.24 7.76-2.12 6.36-6.36 2.12 2.12-6.36 6.36-2.12z"/></>,
            BrainCircuit: <><path d="M12 4.5V2"/><path d="M18 11h2.5"/><path d="M12 19.5V22"/><path d="M5.5 11H3"/><path d="M12 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/><path d="M16 12.5V11a4 4 0 0 0-8 0v1.5"/><path d="M16 8a4 4 0 0 0-8 0"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            Copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>,
            Check: <polyline points="20 6 9 17 4 12"/>,
            ChevronDown: <polyline points="6 9 12 15 18 9" />,
            Settings: <><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            X: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>,
            Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
            // 自定義角色剪影
            ChiikawaSilhouette: <path d="M12 22C6.5 22 2 17.5 2 12C2 8.5 4 5.5 7 4.2C7.3 3 8.3 2 9.5 2C10.2 2 10.8 2.4 11.2 3C11.5 3 11.7 3 12 3C12.3 3 12.5 3 12.8 3C13.2 2.4 13.8 2 14.5 2C15.7 2 16.7 3 17 4.2C20 5.5 22 8.5 22 12C22 17.5 17.5 22 12 22Z" fill="currentColor" />,
            HachiwareSilhouette: <path d="M12 22C6.5 22 2 17.5 2 12C2 8.5 4 6 6 4.5L8 2.5L10 4.5C10.5 4.2 11.2 4 12 4C12.8 4 13.5 4.2 14 4.5L16 2.5L18 4.5C20 6 22 8.5 22 12C22 17.5 17.5 22 12 22Z" fill="currentColor" />,
            UsagiSilhouette: <path d="M12 22C6.5 22 2 17.5 2 12C2 9.5 3.5 7.5 5.5 6.5L6 2L9 2L8.5 6.1C9.5 5.5 10.7 5 12 5C13.3 5 14.5 5.5 15.5 6.1L15 2L18 2L18.5 6.5C20.5 7.5 22 9.5 22 12C22 17.5 17.5 22 12 22Z" fill="currentColor" />
        };

        const Icon = ({ name, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {ICONS[name] || null}
            </svg>
        );

        const TAROT_DATA = [
            { id: 0, numeral: "0", title: "愚者", french: "Le Fou", meaning: "開端與冒險", astrology: "天王星", essence: "最初的虛無", uprightInsight: "全新的開始，勇敢踏出冒險的第一步。", reversedInsight: "暗示過於魯莽不計後果，需謹慎觀察再行動。" },
            { id: 1, numeral: "I", title: "魔術師", french: "Le Bateleur", meaning: "創造與能力", astrology: "水星", essence: "萬物的開端", uprightInsight: "你已具備所有成功工具，現在正是實踐想法的時刻。", reversedInsight: "潛力受限或被浪費，需釐清目標重新導引能量。" },
            { id: 2, numeral: "II", title: "女祭司", french: "La Papesse", meaning: "直覺與神秘", astrology: "月球", essence: "陰陽", uprightInsight: "深度連結直覺，靜待真相與智慧自然浮現。", reversedInsight: "忽視內在聲音，陷入情緒困擾或表象迷惘。" },
            { id: 3, numeral: "III", title: "皇后", french: "L'Impératrice", meaning: "豐收與生命力", astrology: "金星", essence: "愛、生命、和平", uprightInsight: "創造力奔湧，生命充滿恩惠、豐饒與母性的溫柔。", reversedInsight: "成長停滯或過度控制，需找回環境與身心的平衡。" },
            { id: 4, numeral: "IV", title: "皇帝", french: "L'Emperuer", meaning: "秩序與權威", astrology: "白羊座", essence: "四大元素", uprightInsight: "展現領導力，建立穩定且有秩序的長期結構。", reversedInsight: "僵化專制或缺乏自控，容易導致局勢失衡。" },
            { id: 5, numeral: "V", title: "教皇", french: "Le Pape", meaning: "知識與傳統", astrology: "金牛座", essence: "平均力量", uprightInsight: "尋求智慧引導，遵循正統價值或靈性傳統。", reversedInsight: "挑戰權威或陳規，尋求獨立思考與非正統的新路。" },
            { id: 6, numeral: "VI", title: "戀人", french: "L'Amant", meaning: "祝福與契合", astrology: "雙子座", essence: "天地調和", uprightInsight: "完美契合的關係，面臨忠於心靈的關鍵選擇。", reversedInsight: "價值觀分歧，需檢視內在矛盾與外在誘惑。" },
            { id: 7, numeral: "VII", title: "戰車", french: "Le Chariot", meaning: "意志與勝利", astrology: "巨蟹座", essence: "熱情", uprightInsight: "意志堅定，以強大的行動力克服眼前障礙。", reversedInsight: "失控或停滯不前，需重新找回核心動力方向。" },
            { id: 8, numeral: "VIII", title: "力量", french: "La Force", meaning: "勇氣與堅韌", astrology: "獅子座", essence: "穩定", uprightInsight: "以柔克剛，展現內在不屈的慈悲與心理強韌度。", reversedInsight: "軟弱無力，或者是被原始慾望與恐懼支配。" },
            { id: 9, numeral: "IX", title: "隱者", french: "L'Ermite", meaning: "內省與智慧", astrology: "處女座", essence: "調和大三角", uprightInsight: "向內探索，在孤獨的沉靜中遇見真實的自我。", reversedInsight: "過度疏離導致的孤立，需警惕偏激與固執。" },
            { id: 10, numeral: "X", title: "命運之輪", french: "La Roue de fortune", meaning: "週期與轉機", astrology: "木星", essence: "宇宙基礎", uprightInsight: "轉機降臨，命運的齒輪正帶領你進入新階段。", reversedInsight: "運氣停滯或反覆，需學會順應自然循環。" },
            { id: 11, numeral: "XI", title: "正義", french: "La Justice", meaning: "公平與客觀", astrology: "天秤座", essence: "不完整", uprightInsight: "誠實無私，事物正朝向因果平衡的良性發展。", reversedInsight: "面臨不公或偏見，需審視自身誠信與決策。" },
            { id: 12, numeral: "XII", title: "倒吊人", french: "Le Pendu", meaning: "犧牲與覺醒", astrology: "海王星", essence: "終點", uprightInsight: "轉換觀點，以暫時的靜止換取更高層次的覺醒。", reversedInsight: "徒勞無功的犧牲，或無止盡的拖延導致僵局。" },
            { id: 13, numeral: "XIII", title: "死神", french: "La Mort", meaning: "終結與轉化", astrology: "天蠍座", essence: "死亡人數", uprightInsight: "徹底捨棄舊有模式，迎接純淨且必然的新生。", reversedInsight: "恐懼改變，抗拒必然的結束與轉化。" },
            { id: 14, numeral: "XIV", title: "節制", french: "Tempérance", meaning: "平衡與調和", astrology: "射手座", essence: "適當", uprightInsight: "融合不同元素，在耐心等待中事物趨於完美。", reversedInsight: "能量失衡，過度極端導致身心狀態紊換。" },
            { id: 15, numeral: "XV", title: "惡魔", french: "Le Diable", meaning: "慾望與制約", astrology: "魔羯座", essence: "野性", uprightInsight: "面對影子，覺察制約你的物質執迷與慾望。", reversedInsight: "意識到制約存在，即將從執迷中解脫重獲自由。" },
            { id: 16, numeral: "XVI", title: "塔", french: "La Maison Dieu", meaning: "劇變與啟示", astrology: "火星", essence: "惡意基盤", uprightInsight: "劇烈瓦解舊有偽裝，真相即將在廢墟中顯現。", reversedInsight: "緩慢的衰敗，或是剛躲過一場重大的人生意震盪。" },
            { id: 17, numeral: "XVII", title: "星星", french: "L'Étoile", meaning: "希望與療癒", astrology: "水瓶座", essence: "治癒", uprightInsight: "希望湧現，心靈在暴風雨過後獲得寧靜療癒。", reversedInsight: "暫時迷失願景，需重新點燃內在微弱的星光。" },
            { id: 18, numeral: "XVIII", title: "月亮", french: "La Lune", meaning: "不安與潛意識", astrology: "雙魚座", essence: "不安淨化", uprightInsight: "警惕幻覺，傾聽不安表象下的深層潛意識引導。", reversedInsight: "迷霧逐漸散去，從混亂與恐懼中看清事實真相。" },
            { id: 19, numeral: "XIX", title: "太陽", french: "Le Soleil", meaning: "光明與成功", astrology: "太陽", essence: "新生命", uprightInsight: "成功在望，所有努力都將獲得圓滿的豐碩喜悅。", reversedInsight: "暫時的陰影，提防過度樂觀導致的虛榮盲點。" },
            { id: 20, numeral: "XX", title: "審判", french: "Le Juge", meaning: "復活與感召", astrology: "冥王星", essence: "極限", uprightInsight: "靈魂覺醒，原諒過去，迎接生命進階的時刻。", reversedInsight: "拒絕面對真實自我，延誤了蛻變與成長契機。" },
            { id: 21, numeral: "XXI", title: "世界", french: "Le Monde", meaning: "完美與圓滿", astrology: "土星", essence: "最終虛無", uprightInsight: "完美的整合與達成，這段人生旅程功德圓滿。", reversedInsight: "接近成功，但仍有一塊關鍵拼圖尚待心領神會。" }
        ];

        const CHIIKAWA_IMAGES = {
            0: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/0.jpg",
            1: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/1.jpg",
            2: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/2.jpg",
            3: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/3.jpg",
            4: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/4.jpg",
            5: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/5.jpg",
            6: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/6.jpg",
            7: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/7.jpg",
            8: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/8.jpg",
            9: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/9.jpg",
            10: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/10.jpg",
            11: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/11.jpg",
            12: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/12.jpg",
            13: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/13.jpg",
            14: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/14.jpg",
            15: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/15.jpg",
            16: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/16.jpg",
            17: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/17.jpg",
            18: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/18.jpg",
            19: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/19.jpg",
            20: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/20.jpg",
            21: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/21.jpg"
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('divination');
            const [theme, setTheme] = useState('night');
            const [gameState, setGameState] = useState('idle');
            const [spreadType, setSpreadType] = useState('one');
            const [userQuestion, setUserQuestion] = useState('');
            const [selectedCards, setSelectedCards] = useState([]);
            const [aiResponse, setAiResponse] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [copyStatus, setCopyStatus] = useState(false);
            const [secretClickCount, setSecretClickCount] = useState(0);
            
            const [isKeySetupVisible, setIsKeySetupVisible] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(sessionStorage.getItem('arcanum_authenticated') === 'true');
            const [unlockPassInput, setUnlockPassInput] = useState('');
            const [masterKeyInput, setMasterKeyInput] = useState('');
            const [masterPasscodeInput, setMasterPasscodeInput] = useState('');
            const [zoomedImage, setZoomedImage] = useState(null);

            const handleSecretClick = () => {
                const nextCount = secretClickCount + 1;
                if (nextCount >= 5) {
                    setTheme('chiikawa-pink');
                    setSecretClickCount(0);
                } else {
                    setSecretClickCount(nextCount);
                }
            };

            const toggleTheme = () => {
                if (theme === 'chiikawa-pink') setTheme('chiikawa-blue');
                else if (theme === 'chiikawa-blue') setTheme('chiikawa-yellow');
                else if (theme === 'chiikawa-yellow') setTheme('chiikawa-pink');
                else setTheme(prev => prev === 'night' ? 'day' : 'night');
            };

            const returnToClassic = () => setTheme('night');
            const isChiikawa = theme.startsWith('chiikawa');

            const themeStyles = useMemo(() => {
                const styles = {
                    night: {
                        bg: "bg-[#020617]", text: "text-slate-100", secondaryText: "text-slate-400",
                        glow1: "bg-indigo-900", glow2: "bg-purple-900", navBg: "bg-slate-900/80", cardBg: "bg-slate-900",
                        btnBg: "bg-white text-slate-950 shadow-lg", panelBg: "bg-slate-900/60", border: "border-white/10",
                        inputBg: "bg-slate-900/40", activeBtn: "border-white bg-white/20 shadow-lg", accent: "#818cf8"
                    },
                    day: {
                        bg: "bg-[#fffbeb]", text: "text-slate-800", secondaryText: "text-slate-500",
                        glow1: "bg-amber-200", glow2: "bg-orange-200", navBg: "bg-white/80", cardBg: "bg-white",
                        btnBg: "bg-slate-900 text-white shadow-lg", panelBg: "bg-white/80", border: "border-amber-900/10",
                        inputBg: "bg-white/60", activeBtn: "border-slate-800 bg-slate-800 text-white", accent: "#ea580c"
                    },
                    'chiikawa-pink': {
                        bg: "bg-[#EFA5C9]", text: "text-[#5D2E46]", secondaryText: "text-[#8E4A6E]",
                        glow1: "bg-white/40", glow2: "bg-[#FADDE9]", navBg: "bg-white/70", cardBg: "bg-white",
                        btnBg: "bg-[#D64E8B] text-white shadow-lg border-2 border-white/30",
                        activeBtn: "bg-[#D64E8B] border-[#D64E8B] text-white", 
                        panelBg: "bg-[#FFF0F6]/95", border: "border-[#F4C1D9]", inputBg: "bg-white/70", accent: "#D64E8B"
                    },
                    'chiikawa-blue': {
                        bg: "bg-[#91A8D0]", text: "text-[#1B2A4E]", secondaryText: "text-[#3D5A80]",
                        glow1: "bg-white/40", glow2: "bg-[#D1DCEE]", navBg: "bg-white/70", cardBg: "bg-white",
                        btnBg: "bg-[#3D5A80] text-white shadow-lg border-2 border-white/30",
                        activeBtn: "bg-[#3D5A80] border-[#3D5A80] text-white",
                        panelBg: "bg-[#E8EEF8]/95", border: "border-[#B8C9E5]", inputBg: "bg-white/70", accent: "#3D5A80"
                    },
                    'chiikawa-yellow': {
                        bg: "bg-[#FFF9D4]", text: "text-[#4D432A]", secondaryText: "text-[#7A6F44]",
                        glow1: "bg-white/50", glow2: "bg-[#FEF5BC]", navBg: "bg-white/70", cardBg: "bg-white",
                        btnBg: "bg-[#96831A] text-white shadow-lg", activeBtn: "bg-[#96831A] border-[#96831A] text-white",
                        panelBg: "bg-[#FFFEF2]/95", border: "border-[#E8DE95]", inputBg: "bg-white/70", accent: "#96831A"
                    }
                };
                return styles[theme];
            }, [theme]);

            const fetchAiInterpretation = async (question, cards, type) => {
                const savedKey = (localStorage.getItem('arcanum_gemini_key') || "").trim();
                if (!savedKey) return;
                setIsAiLoading(true);
                setAiResponse('');
                const cardDetails = cards.map((c, i) => `${type === 'triangle' ? ['過去','現在','未來'][i] : '核心'}: ${c.title}(${c.isReversed ? '逆位' : '正位'}) - ${c.meaning}`).join('\n');
                
                const prompt = `你是一位專業、睿智且溫暖的塔羅大師。問題：${question || '求指引'}。牌陣內容：\n${cardDetails}\n\n請提供約 300 字深度解讀。深度結合各牌面間的連結與牌義，風格應溫暖大方，好結果鼓勵，壞結果轉化為溫柔的教導與具體建議。不要使用Markdown符號，直接繁體中文排版。`;

                try {
                    // 使用 Gemini 2.5 Flash 專屬模型名稱
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${savedKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    const text = (data.candidates?.[0]?.content?.parts?.[0]?.text || "").replace(/[*#]/g, '').trim();
                    setAiResponse(text);
                } catch (e) {
                    setAiResponse(`宇宙感應發生錯誤：${e.message}。請確認您的 API Key 設定及權限。`);
                } finally {
                    setIsAiLoading(false);
                }
            };

            const drawCards = () => {
                setGameState('shuffling');
                setTimeout(() => {
                    const count = spreadType === 'one' ? 1 : 3;
                    const drawn = [...TAROT_DATA].sort(() => Math.random() - 0.5).slice(0, count).map(c => ({
                        ...c, isReversed: Math.random() > 0.35, timestamp: new Date().toLocaleTimeString()
                    }));
                    setSelectedCards(drawn);
                    setGameState('revealed');
                    if (isAuthenticated) fetchAiInterpretation(userQuestion, drawn, spreadType);
                }, 2000);
            };

            const handleUnlockInterpretation = () => {
                const savedPass = (localStorage.getItem('arcanum_access_pass') || "").trim();
                if (unlockPassInput.trim() === savedPass) {
                    setIsAuthenticated(true);
                    sessionStorage.setItem('arcanum_authenticated', 'true');
                    fetchAiInterpretation(userQuestion, selectedCards, spreadType);
                } else {
                    alert('密碼不正確。');
                }
            };

            const resetGame = () => {
                setGameState('idle');
                setSelectedCards([]);
                setAiResponse('');
                setUserQuestion('');
            };

            const copyToClipboard = () => {
                const text = `【阿爾克納啟示】\n問題：${userQuestion || '指引'}\n\n${aiResponse}\n\n— 命運之鍵由你掌握`;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                setCopyStatus(true);
                setTimeout(() => setCopyStatus(false), 2000);
            };

            const handleSetup = () => {
                if (masterKeyInput.trim() && masterPasscodeInput.trim()) {
                    localStorage.setItem('arcanum_gemini_key', masterKeyInput.trim());
                    localStorage.setItem('arcanum_access_pass', masterPasscodeInput.trim());
                    setIsKeySetupVisible(false);
                    alert('系統設定成功！');
                } else {
                    alert('請填寫完整資訊');
                }
            };

            const GuidePage = () => {
                const [expandedId, setExpandedId] = useState(null);
                return (
                    <div className="animate-in space-y-8 pb-10">
                        <div className="flex justify-between items-end">
                            <h2 className="text-3xl font-serif font-bold tracking-widest transition-colors duration-1000">占卜指南</h2>
                            <button onClick={() => { if(confirm('確定要重設系統嗎？')){localStorage.clear(); location.reload();} }} className="text-[10px] flex items-center gap-1 font-bold opacity-30 hover:opacity-100 transition-opacity">
                                <Icon name="RefreshCw" size={10} /> 重設系統
                            </button>
                        </div>
                        
                        <div className="space-y-8">
                            <section className="space-y-4">
                                <h3 className="font-bold text-lg opacity-80 border-l-4 border-indigo-500 pl-3 transition-colors duration-1000">基本說明</h3>
                                <div className="space-y-4 text-sm leading-relaxed opacity-70">
                                    <div className="glass-panel p-6 rounded-[2rem]">
                                        <p className="font-bold text-indigo-400 mb-2 font-serif tracking-widest transition-colors duration-1000">● 尋找牌靈</p>
                                        <p>選擇一張在此刻最令你產生共鳴的牌作為您的「牌靈」，它代表您此時的靈魂投射。</p>
                                    </div>
                                    <div className="glass-panel p-6 rounded-[2rem]">
                                        <p className="font-bold text-amber-400 mb-2 font-serif tracking-widest transition-colors duration-1000">● 每日抽牌</p>
                                        <p>每天晨間詢問「我今日需要注意什麼？」。透過日常的反思練習直覺力。</p>
                                    </div>
                                </div>
                            </section>

                            <section className="space-y-4">
                                <h3 className="font-bold text-lg opacity-80 border-l-4 border-rose-500 pl-3 transition-colors duration-1000">大阿爾克那圖鑑</h3>
                                <div className="space-y-2">
                                    {TAROT_DATA.map(c => (
                                        <div key={c.id} className="border border-white/5 rounded-2xl overflow-hidden glass-panel">
                                            <button onClick={() => setExpandedId(expandedId === c.id ? null : c.id)} className="w-full flex items-center justify-between p-5 text-left transition-colors hover:bg-white/5">
                                                <div className="flex items-center gap-4">
                                                    <span className="font-mono text-xs opacity-40">{c.numeral}</span>
                                                    <span className="font-bold tracking-widest">{c.title}</span>
                                                </div>
                                                <Icon name="ChevronDown" size={16} className={`transition-transform ${expandedId === c.id ? 'rotate-180' : ''}`} />
                                            </button>
                                            {expandedId === c.id && (
                                                <div className="p-6 bg-black/20 text-xs space-y-4 animate-in">
                                                    <p className="opacity-80 font-bold">{c.essence} · {c.meaning}</p>
                                                    <div className="grid grid-cols-1 gap-3 leading-relaxed text-justify">
                                                        <p><span className="text-indigo-300 font-bold">正位：</span>{c.uprightInsight}</p>
                                                        <p><span className="text-rose-300 font-bold">逆位：</span>{c.reversedInsight}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </section>

                            <button onClick={() => setIsKeySetupVisible(true)} className="w-full py-4 border border-dashed border-white/20 rounded-2xl opacity-40 text-xs hover:opacity-100 transition-all font-bold">
                                {localStorage.getItem('arcanum_gemini_key') ? '管理員設定更新' : '管理員初始設定'}
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen ${themeStyles.bg} ${themeStyles.text} transition-colors duration-1000 pb-24 selection:bg-white/20`}>
                    <div className="fixed inset-0 overflow-hidden pointer-events-none opacity-20">
                        <div className={`absolute top-[-10%] left-[-10%] w-[80%] h-[40%] ${themeStyles.glow1} rounded-full blur-[120px] transition-colors duration-1000`} />
                        <div className={`absolute bottom-[-10%] right-[-10%] w-[80%] h-[40%] ${themeStyles.glow2} rounded-full blur-[120px] transition-colors duration-1000`} />
                    </div>

                    {/* 圖片放大檢視 */}
                    {zoomedImage && (
                        <div className="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-4 animate-in fade-in" onClick={() => setZoomedImage(null)}>
                            <img src={zoomedImage} className="max-w-full max-h-full rounded-2xl shadow-2xl animate-in zoom-in duration-300" alt="Tarot" />
                            <button className="absolute top-8 right-8 text-white/50 hover:text-white transition-colors" onClick={() => setZoomedImage(null)}>
                                <Icon name="X" size={40} />
                            </button>
                        </div>
                    )}

                    {isKeySetupVisible && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/90 backdrop-blur-md animate-in no-select">
                            <div className="w-full max-w-sm glass-panel rounded-[3rem] p-10 space-y-8 shadow-2xl">
                                <div className="text-center space-y-2">
                                    <h3 className="text-2xl font-serif font-bold">系統初始化</h3>
                                    <p className="text-[10px] opacity-50 leading-relaxed">設定 Gemini API Key 與解鎖啟示用的密碼</p>
                                </div>
                                <div className="space-y-4">
                                    <input type="password" value={masterKeyInput} onChange={e=>setMasterKeyInput(e.target.value)} placeholder="Gemini API Key" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-indigo-400" />
                                    <input type="text" value={masterPasscodeInput} onChange={e=>setMasterPasscodeInput(e.target.value)} placeholder="親友用的解鎖密碼" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-indigo-400" />
                                </div>
                                <button onClick={handleSetup} className="w-full py-4 bg-white text-slate-900 rounded-full font-bold text-sm btn-press transition-all shadow-xl">完成設定</button>
                                <button onClick={() => setIsKeySetupVisible(false)} className="w-full text-[10px] opacity-30 uppercase font-bold tracking-widest mt-4">取消</button>
                            </div>
                        </div>
                    )}

                    <div className="relative z-10 max-lg mx-auto px-6 py-8">
                        <header className="flex justify-between items-center mb-10 animate-in no-select transition-colors duration-1000">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={handleSecretClick}>
                                <div className="p-2 rounded-xl bg-white/20">
                                    <Icon name={isChiikawa ? "Heart" : "Sparkles"} className={isChiikawa ? "animate-pulse text-white" : ""} />
                                </div>
                                <h1 className="text-xl font-serif font-bold tracking-widest transition-colors duration-1000">
                                    {isChiikawa ? '阿爾克納 & Chiikawa' : '阿爾克那'}
                                </h1>
                            </div>
                            <div className="flex gap-2">
                                {isChiikawa && <button onClick={returnToClassic} className="w-10 h-10 rounded-full flex items-center justify-center border bg-white/10 shadow-sm btn-press transition-all"><Icon name="LogOut" size={16} /></button>}
                                <button onClick={toggleTheme} className="w-10 h-10 rounded-full flex items-center justify-center border bg-white/10 shadow-sm btn-press transition-all">
                                    {theme === 'chiikawa-pink' ? <Icon name="ChiikawaSilhouette" size={20} /> :
                                     theme === 'chiikawa-blue' ? <Icon name="HachiwareSilhouette" size={20} /> :
                                     theme === 'chiikawa-yellow' ? <Icon name="UsagiSilhouette" size={20} /> :
                                     (theme === 'night' ? <Icon name="Moon" size={20} /> : <Icon name="Sun" size={20} />)}
                                </button>
                            </div>
                        </header>

                        {activeTab === 'divination' && (
                            <div className="animate-in">
                                {gameState === 'idle' && (
                                    <div className="space-y-8">
                                        <h2 className="text-4xl font-serif font-bold leading-tight transition-colors duration-1000">
                                            {isChiikawa ? '嘿！現在\n想問什麼？' : '現在\n你想問什麼？'}
                                        </h2>
                                        <textarea value={userQuestion} onChange={e => setUserQuestion(e.target.value)} placeholder="在此輸入您的問題..." className={`w-full h-36 ${themeStyles.inputBg} border ${themeStyles.border} rounded-3xl p-6 focus:outline-none transition-all resize-none shadow-xl text-lg transition-colors duration-1000 placeholder:opacity-30`} />
                                        <div className="flex gap-4">
                                            <button onClick={() => setSpreadType('one')} className={`flex-1 p-5 rounded-3xl border-2 transition-all group btn-press ${spreadType === 'one' ? themeStyles.activeBtn : 'border-white/5 bg-white/5 opacity-40'}`}>
                                                <Icon name="Compass" size={24} className="mx-auto mb-2 opacity-50" />
                                                <span className="text-sm font-bold block">一牌直覺</span>
                                            </button>
                                            <button onClick={() => setSpreadType('triangle')} className={`flex-1 p-5 rounded-3xl border-2 transition-all group btn-press ${spreadType === 'triangle' ? themeStyles.activeBtn : 'border-white/5 bg-white/5 opacity-40'}`}>
                                                <Icon name="Layout" size={24} className="mx-auto mb-2 opacity-50" />
                                                <span className="text-sm font-bold block">聖三角</span>
                                            </button>
                                        </div>
                                        <button onClick={drawCards} className={`w-full py-6 ${themeStyles.btnBg} rounded-full font-bold tracking-[0.3em] btn-press transition-all text-xl shadow-2xl uppercase transition-colors duration-1000`}>啟動靈性感應</button>
                                    </div>
                                )}

                                {gameState === 'shuffling' && (
                                    <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-8 transition-colors duration-1000">
                                        <div className="relative w-32 h-48 animate-pulse">
                                            {[0,1,2].map(i => <div key={i} className="absolute inset-0 bg-white/10 border-2 border-white/20 rounded-xl" style={{ transform: `rotate(${i*12-12}deg)` }} />)}
                                        </div>
                                        <p className="text-xl font-serif italic animate-bounce tracking-[0.2em]">正在搜尋命運軌跡...</p>
                                    </div>
                                )}

                                {gameState === 'revealed' && (
                                    <div className="space-y-10 animate-in">
                                        <div className="flex flex-wrap justify-center gap-6">
                                            {selectedCards.map((c, i) => (
                                                <div key={i} className="flex flex-col items-center gap-3">
                                                    <div className={`relative w-44 h-72 rounded-xl p-0.5 bg-gradient-to-br from-white/80 to-white/20 shadow-2xl ${c.isReversed ? 'rotate-180' : ''}`}>
                                                        <div className={`w-full h-full ${themeStyles.cardBg} rounded-lg flex flex-col items-center justify-between relative overflow-hidden transition-colors duration-1000`}>
                                                            <div className="absolute top-2 left-3 text-[10px] opacity-30 font-serif z-10">{c.numeral}</div>
                                                            
                                                            <div className="flex-1 w-full relative group">
                                                                {isChiikawa ? (
                                                                    <div className="w-full h-full cursor-zoom-in" onClick={() => setZoomedImage(CHIIKAWA_IMAGES[c.id])}>
                                                                        <img src={CHIIKAWA_IMAGES[c.id]} className="w-full h-full object-cover opacity-90 hover:opacity-100 transition-all" alt={c.title} />
                                                                        <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                                                            <Icon name="Compass" size={24} className="text-white animate-pulse" />
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    <div className="w-full h-full flex flex-col items-center justify-center space-y-3 pt-6">
                                                                        <Icon name={c.id === 19 ? "Sun" : (c.id === 18 ? "Moon" : "Star")} size={48} className="opacity-40" />
                                                                        <div className="text-center font-bold tracking-widest">{c.title}</div>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            <div className={`w-full py-2 px-3 text-center z-10 ${isChiikawa ? 'bg-black/60 backdrop-blur-md' : ''}`}>
                                                                {isChiikawa && <div className="text-[11px] font-bold tracking-widest text-white">{c.title}</div>}
                                                                <div className={`text-[8px] uppercase font-mono tracking-tighter ${isChiikawa ? 'text-white/50' : 'opacity-20'}`}>{c.essence}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <span className="text-[10px] uppercase opacity-60 font-bold tracking-widest">{c.isReversed ? '逆位' : '正位'}</span>
                                                </div>
                                            ))}
                                        </div>

                                        <div className="space-y-6">
                                            <div className="glass-panel rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden transition-colors duration-1000">
                                                <div className="flex items-center gap-3 mb-6 opacity-60 transition-colors duration-1000"><Icon name="BrainCircuit" size={20} /><h3 className="font-bold tracking-widest uppercase italic">宇宙的深層啟示</h3></div>
                                                
                                                {isAiLoading ? (
                                                    <div className="flex flex-col items-center py-10 gap-4">
                                                        <Icon name="RefreshCw" className="animate-spin opacity-30" size={32} />
                                                        <p className="animate-pulse text-sm opacity-40 tracking-widest">正在感應這份能量...</p>
                                                    </div>
                                                ) : aiResponse ? (
                                                    <div className="leading-relaxed font-light text-justify whitespace-pre-wrap text-base animate-in">
                                                        {aiResponse}
                                                    </div>
                                                ) : !isAuthenticated ? (
                                                    <div className="py-10 flex flex-col items-center gap-6 animate-in">
                                                        <Icon name="Lock" size={40} className="opacity-20" />
                                                        <div className="text-center space-y-2">
                                                            <p className="text-sm opacity-50 font-light">深度啟示已被加密鎖定</p>
                                                            <p className="text-[10px] opacity-30 uppercase tracking-widest">請輸入密碼以解鎖深度解析</p>
                                                        </div>
                                                        <div className="flex w-full gap-2 px-4 max-w-xs">
                                                            <input 
                                                                type="text" 
                                                                value={unlockPassInput} 
                                                                onChange={e=>setUnlockPassInput(e.target.value)} 
                                                                placeholder="輸入密碼" 
                                                                className="flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-center text-sm focus:outline-none focus:border-indigo-400" 
                                                            />
                                                            <button onClick={handleUnlockInterpretation} className="bg-white text-slate-900 px-6 rounded-xl font-bold text-xs btn-press shadow-lg">解鎖</button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="text-center py-10 opacity-30 italic text-sm">正在準備啟示內容...</div>
                                                )}
                                            </div>

                                            {selectedCards.map((c, i) => (
                                                <div key={i} className={`p-7 rounded-[2.5rem] border ${themeStyles.border} bg-white/5 text-sm space-y-4 shadow-md transition-colors duration-1000`}>
                                                    <div className="flex justify-between items-center mb-5 transition-colors duration-1000">
                                                        <h4 className="font-bold flex items-center gap-2"><span className="w-1.5 h-1.5 bg-current opacity-20 rounded-full" />{c.title} 基本解析</h4>
                                                        <span className="text-[9px] font-mono opacity-40">{c.astrology}</span>
                                                    </div>
                                                    <div className="space-y-2 opacity-80 leading-relaxed text-justify transition-colors duration-1000">
                                                        <p className="font-bold">{c.essence} · {c.meaning}</p>
                                                        <p className="italic opacity-60 text-xs leading-relaxed">{c.isReversed ? c.reversedInsight : c.uprightInsight}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <div className="flex flex-col gap-5 pt-4">
                                            {aiResponse && (
                                                <button onClick={copyToClipboard} className={`${isChiikawa ? themeStyles.btnBg : 'bg-indigo-600 text-white shadow-xl'} py-6 rounded-full font-bold flex items-center justify-center gap-3 text-lg btn-press transition-all border-2 border-white/20 shadow-2xl animate-in transition-colors duration-1000`}>
                                                    <Icon name={copyStatus ? "Check" : "Copy"} size={20} /> 
                                                    {copyStatus ? "已複製內容" : "複製這份啟示"}
                                                </button>
                                            )}
                                            <button onClick={resetGame} className={`w-full py-5 border-2 ${themeStyles.border} rounded-full text-base font-bold flex items-center justify-center gap-2 active:scale-95 transition-all uppercase tracking-widest opacity-60 transition-colors duration-1000`}>
                                                <Icon name="RefreshCw" size={20} /> 重新占卜
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'guide' && <GuidePage />}
                    </div>

                    <nav className={`fixed bottom-0 left-0 w-full ${themeStyles.navBg} backdrop-blur-2xl border-t ${themeStyles.border} px-16 py-5 flex justify-around items-center z-50 transition-colors duration-1000 no-select`}>
                        <button onClick={() => setActiveTab('divination')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'divination' ? 'opacity-100 scale-110' : 'opacity-100'}`} style={{color: activeTab === 'divination' ? themeStyles.accent : '#64748b'}}>
                            <Icon name="Sparkles" size={24} />
                            <span className="text-[10px] font-bold uppercase tracking-widest mt-1">占卜</span>
                        </button>
                        <button onClick={() => setActiveTab('guide')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'guide' ? 'opacity-100 scale-110' : 'opacity-100'}`} style={{color: activeTab === 'guide' ? themeStyles.accent : '#64748b'}}>
                            <Icon name="BookOpen" size={24} />
                            <span className="text-[10px] font-bold uppercase tracking-widest mt-1">指南</span>
                        </button>
                    </nav>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
