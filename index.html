import React, { useState, useEffect, useRef } from 'react';
import { Sparkles, RefreshCw, Info, Moon, Sun, Star, BookOpen, Layout, History, Compass, MessageCircle, Share2, Loader2, BrainCircuit, X, Heart, Palette, Wand2, LogOut } from 'lucide-react';

const apiKey = ""; // 執行環境會自動提供 Key

// 吉伊卡哇塔羅圖片路徑
const CHIIKAWA_IMAGES = {
  0: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/0.jpg",
  1: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/1.jpg",
  2: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/2.jpg",
  3: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/3.jpg",
  4: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/4.jpg",
  5: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/5.jpg",
  6: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/6.jpg",
  7: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/7.jpg",
  8: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/8.jpg",
  9: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/9.jpg",
  10: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/10.jpg",
  11: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/11.jpg",
  12: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/12.jpg",
  13: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/13.jpg",
  14: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/14.jpg",
  15: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/15.jpg",
  16: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/16.jpg",
  17: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/17.jpg",
  18: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/18.jpg",
  19: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/19.jpg",
  20: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/20.jpg",
  21: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/21.jpg"
};

const TAROT_DATA = [
  { id: 0, numeral: "0", title: "愚者", french: "Le Fou", meaning: "狡猾之者", astrology: "天王星", essence: "最初的虛無", uprightInsight: "代表一個全新的開始，充滿無限可能。不要害怕未知，保持赤子之心去冒險。這是一個充滿勇氣與信任的時刻。", reversedInsight: "暗示過於魯娘或不負責任。在跳入深淵之前，請先確認腳下的土地是否穩固，小心因為缺乏規劃而導致失敗。" },
  { id: 1, numeral: "I", title: "魔術師", french: "Le Bateleur", meaning: "出發、發現、創造", astrology: "水星", essence: "萬物的開端", uprightInsight: "你已經擁有了達成目標所需的所有工具。現在是將想法轉化為現實的時刻，展現你的創造力與資源整合能力。", reversedInsight: "潛力可能被浪費，或者你的能力未被正確引導。小心身邊的欺瞞，或者是你對自己的能力缺乏信心而不敢行動。" },
  { id: 2, numeral: "II", title: "女祭司", french: "La Papesse", meaning: "女性的神秘", astrology: "月球", essence: "陰陽", uprightInsight: "傾聽你的直覺與夢境。有些真相不需要外求，而是需要安靜地等待其浮現。內在的智慧正引領著你。", reversedInsight: "忽視了內心的聲音。可能過於壓抑情感，或是過度投入感官世界而失去了靈性的連結，需重新找回寧靜。" },
  { id: 3, numeral: "III", title: "皇后", french: "L'Impératrice", meaning: "包容、豐收、豐腴", astrology: "金星", essence: "愛、生命、和平", uprightInsight: "大地的豐饒與創造力正在流動。這是一個孕育計畫、藝術創作或情感增長的好時機，環境充滿了愛與包容。", reversedInsight: "過度的保護欲可能導致窒息，或者是創造力陷入停滯。需要重新尋求內在與外在的平衡，避免過度依賴物質。" },
  { id: 4, numeral: "IV", title: "皇帝", french: "L'Emperuer", meaning: "自我的權利", astrology: "白羊座", essence: "四大元素", uprightInsight: "展現領導力與紀律。結構與秩序將為你帶來成功，這是採取權威立場、建立規則並穩定局勢的時候。", reversedInsight: "暗示暴政或控制欲過強。過於僵化的規則可能阻礙了成長，或者是你目前缺乏自我控制力，導致混難。" },
  { id: 5, numeral: "V", title: "教皇", french: "Le Pape", meaning: "知識與道德", astrology: "金牛座", essence: "平均的力量", uprightInsight: "遵循傳統或尋求專業的導引。在團體規範與精神導師中，你將找到答案，適合學習或尋求傳統價值的認同。", reversedInsight: "鼓勵打破陳規，挑戰傳統權威。是時候尋找屬於你自己的真理，而非盲目跟隨他人的信念或制度。" },
  { id: 6, numeral: "VI", title: "戀人", french: "L'Amant", meaning: "上天的祝福", astrology: "雙子座", essence: "天地的調和", uprightInsight: "面臨關鍵的選擇與和諧的關係。這不僅關於愛情，更是關於價值觀的對齊與心靈層面的完美契合。", reversedInsight: "關係可能失衡或決策不一。可能面臨內心的矛盾，或者因為短暫的誘惑而迷失了長遠的方向與承諾。" },
  { id: 7, numeral: "VII", title: "戰車", french: "Le Chariot", meaning: "熱情", astrology: "巨蟹座", essence: "勝利", uprightInsight: "憑藉強大的意志力克服障礙。專注目標，讓理智與意志驅動你的成功之路，這是一段快速前進的時期。", reversedInsight: "方向迷失或情緒失控。過度的野心可能導致衝突，或者因為缺乏意志力與計畫而導致計畫停滯不前。" },
  { id: 8, numeral: "VIII", title: "力量", french: "La Force", meaning: "支配", astrology: "獅子座", essence: "力量的穩定", uprightInsight: "以柔克剛，展現內在的勇氣。真正的力量來自於慈悲、韌性以及對自我本能的完全接納與導引。", reversedInsight: "可能感到自卑或被原始慾望支配。感到無力應對現況，或者因為情緒起伏過大而失去了對局勢的掌控。" },
  { id: 9, numeral: "IX", title: "隱者", french: "L'Ermite", meaning: "知識", astrology: "處女座", essence: "調和大三角", uprightInsight: "向內探索，尋求孤獨與反思。暫時遠離塵囂，你將在寂靜中看見真理之光，這是一個尋求內在導引的時期。", reversedInsight: "過度與世隔絕或逃避現實。小心孤芳自賞所帶來的盲點，或者是拒絕聽取明智的建議而陷入固執。" },
  { id: 10, numeral: "X", title: "命運之輪", french: "La Roue de la fortune", meaning: "天使與魔鬼", astrology: "木星", essence: "宇宙的基礎", uprightInsight: "轉機即將來臨。接受命運的波動，這是一個週期性的轉變，宇宙的力量正將你推向一個新的階段。", reversedInsight: "運氣的停滯或不順遂。不要試圖抵抗必然的改變，學會適應週期性的低潮，並從過去的錯誤中學習。" },
  { id: 11, numeral: "XI", title: "正義", french: "La Justice", meaning: "公平的真理", astrology: "天秤座", essence: "不完整", uprightInsight: "誠實地面對現況。因果報應正在運作，客觀與平衡的判斷將引導你走向正確道路，公平將得到彰顯。", reversedInsight: "面臨不公平的待遇或推卸責任。法律或決定可能對你不利，需要檢討自己是否在某處偏離了誠信。" },
  { id: 12, numeral: "XII", title: "倒吊人", french: "Le Pendu", meaning: "自我犧牲", astrology: "海王星", essence: "終點", uprightInsight: "換個角度看世界。現在是等待與觀望的時刻，暫時的停滯是為了換取更高的覺醒與精神上的成長。", reversedInsight: "徒勞無功的犧牲或無謂的拖延。拒絕改變觀點，或者是為了不值得的事物過度消耗自己的能量。" },
  { id: 13, numeral: "XIII", title: "死神", french: "La Mort", meaning: "循環", astrology: "天蠍座", essence: "死亡人數", uprightInsight: "終結與新生的開始。徹底放下舊有的、不再適用的模式，痛苦的結束將迎來更純淨、更高層次的啟程。", reversedInsight: "因為恐懼改變而死守現狀。抗拒必要的結束只會延長痛苦，並阻礙了新生命與新機會的誕生。" },
  { id: 14, numeral: "XIV", title: "節制", french: "Tempérance", meaning: "自我控制", astrology: "射手座", essence: "適當", uprightInsight: "融合與平衡。在極端中尋求中間點，保持耐心與平和的心態，事物將會以最和諧的方式緩緩成形。", reversedInsight: "生活失衡或資源浪費。情緒的極端或行為的過度，導致原本和諧的局面變得混難，需重新調整步調。" },
  { id: 15, numeral: "XV", title: "惡魔", french: "Le Diable", meaning: "慾望", astrology: "魔羯座", essence: "野性", uprightInsight: "面對影子的時刻。你可能被物質慾望、成癮或負面思考束縛。覺察這些鎖鍊是重獲自由的第一步。", reversedInsight: "從束縛中覺醒。你開始意識到心理的陰暗面或病態的關係，並獲得力量去打破那些限制成長的負面習氣。" },
  { id: 16, numeral: "XVI", title: "塔", french: "La Maison Dieu", meaning: "驕傲者必亡", astrology: "火星", essence: "惡意的基盤", uprightInsight: "劇烈且突如其來的崩解。這雖然痛苦，但卻摧毀了虛偽的基礎，讓真相得以顯現，強迫你重新開始。", reversedInsight: "避開了重大的災難或是正經歷緩慢的衰敗。混亂雖然正在醞釀，但你仍有機會在完全瓦解前做最後調整。" },
  { id: 17, numeral: "XVII", title: "星星", french: "L'Étoile", meaning: "魂魄飛向宇宙", astrology: "水瓶座", essence: "治癒", uprightInsight: "希望與平靜。在暴風雨後，星光照亮了前路，這是一個心靈療癒、恢復信心並與宇宙能量連結的時期。", reversedInsight: "感到失望或靈感枯竭。暫時迷失了前進的方向，對未來感到迷惘，需要重新點燃內在之火。" },
  { id: 18, numeral: "XVIII", title: "月亮", french: "La Lune", meaning: "黑暗的降臨", astrology: "雙魚座", essence: "不安、淨化", uprightInsight: "潛意識的波瀾與幻覺。有些事物並非表面所見，需警惕隱藏的敵意、欺騙以及內心深處的不安情緒。", reversedInsight: "迷霧開始散去。隱藏的真相逐漸浮現，雖然不安感依舊存在，但你已經學會如何從混亂中辨識真實。" },
  { id: 19, numeral: "XIX", title: "太陽", french: "Le Soleil", meaning: "崇拜", astrology: "太陽", essence: "新生命誕生", uprightInsight: "純粹的喜悅、成功與活力。生命充滿陽光，所有的努力都將獲得圓滿的成果，這是一個充滿榮耀的時刻。", reversedInsight: "暫時的陰影。雖然成功依舊在望，但可能伴隨著過度的自我膨脹、虛榮或對事物的過度樂觀與依賴。" },
  { id: 20, numeral: "XX", title: "審判", french: "Le Juge", meaning: "復活", astrology: "冥王星", essence: "極限", uprightInsight: "靈魂的覺醒與感召。回顧過去並原諒自己，這是一個重生與邁向更高生命層次的重要決定時刻。", reversedInsight: "拒絕面對過去或延誤了關鍵決定。靈魂的呼喚被忽視，可能因為恐懼被評價或承擔責任而裹足不前。" },
  { id: 21, numeral: "XXI", title: "世界", french: "Le Monde", meaning: "完美無缺", astrology: "土星", essence: "最終的虛無", uprightInsight: "完美的圓滿與旅程的終點。你已經完成了所有的功課，迎來了成功、整合與全方位的達成感。", reversedInsight: "雖然接近成功但仍有未竟之志。最後一塊拼圖尚未拼上，或者是你對完成目標感到拖延與行動力不足。" }
];

const App = () => {
  const [theme, setTheme] = useState('night'); // 'night', 'day', 'chiikawa-pink', 'chiikawa-blue', 'chiikawa-yellow'
  const [activeTab, setActiveTab] = useState('divination');
  const [gameState, setGameState] = useState('idle');
  const [spreadType, setSpreadType] = useState('one');
  const [userQuestion, setUserQuestion] = useState('');
  const [selectedCards, setSelectedCards] = useState([]);
  const [aiResponse, setAiResponse] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [history, setHistory] = useState([]);
  const [isShareMode, setIsShareMode] = useState(false);
  const [secretClickCount, setSecretClickCount] = useState(0);

  // 隱藏模式觸發：點擊標題 5 次
  const handleSecretClick = () => {
    const nextCount = secretClickCount + 1;
    if (nextCount >= 5) {
      setTheme('chiikawa-pink');
      setSecretClickCount(0);
    } else {
      setSecretClickCount(nextCount);
    }
  };

  // 切換邏輯：日夜模式 vs 吉依卡哇三色循環
  const toggleTheme = () => {
    if (theme === 'chiikawa-pink') setTheme('chiikawa-blue');
    else if (theme === 'chiikawa-blue') setTheme('chiikawa-yellow');
    else if (theme === 'chiikawa-yellow') setTheme('chiikawa-pink');
    else setTheme(prev => prev === 'night' ? 'day' : 'night');
  };

  // 返回經典介面
  const returnToClassic = () => {
    setTheme('night');
  };

  const isChiikawa = theme.startsWith('chiikawa');

  const themeStyles = {
    night: {
      bg: "bg-[#020617]",
      text: "text-slate-100",
      secondaryText: "text-slate-400",
      glow1: "bg-indigo-900",
      glow2: "bg-purple-900",
      navBg: "bg-slate-900/80",
      cardBg: "bg-slate-900",
      btnBg: "bg-white text-slate-950 shadow-[0_4px_20px_rgba(255,255,255,0.2)]",
      panelBg: "bg-slate-900/60",
      border: "border-white/10",
      inputBg: "bg-slate-900/40",
      accent: "text-amber-200",
      subAccent: "text-indigo-400"
    },
    day: {
      bg: "bg-[#fffbeb]",
      text: "text-slate-800",
      secondaryText: "text-slate-500",
      glow1: "bg-amber-200",
      glow2: "bg-orange-200",
      navBg: "bg-white/80",
      cardBg: "bg-white",
      btnBg: "bg-slate-900 text-white shadow-[0_4px_20px_rgba(0,0,0,0.15)]",
      panelBg: "bg-white/80",
      border: "border-amber-900/10",
      inputBg: "bg-white/60",
      accent: "text-orange-700",
      subAccent: "text-amber-600"
    },
    'chiikawa-pink': {
      bg: "bg-[#EFA5C9]",
      text: "text-[#5D2E46]",
      secondaryText: "text-[#8E4A6E]",
      glow1: "bg-white/40",
      glow2: "bg-[#FADDE9]",
      navBg: "bg-white/70",
      cardBg: "bg-white",
      btnBg: "bg-[#D64E8B] text-white shadow-[0_4px_15px_rgba(214,78,139,0.4)] border-2 border-white/30",
      activeBtn: "bg-[#D64E8B] border-[#D64E8B] text-white", 
      panelBg: "bg-[#FFF0F6]/95",
      border: "border-[#F4C1D9]",
      inputBg: "bg-white/70",
      accent: "text-[#D64E8B]",
      subAccent: "text-[#EFA5C9]"
    },
    'chiikawa-blue': {
      bg: "bg-[#91A8D0]",
      text: "text-[#1B2A4E]",
      secondaryText: "text-[#3D5A80]",
      glow1: "bg-white/40",
      glow2: "bg-[#D1DCEE]",
      navBg: "bg-white/70",
      cardBg: "bg-white",
      btnBg: "bg-[#3D5A80] text-white shadow-[0_4px_15px_rgba(61,90,128,0.4)] border-2 border-white/30",
      activeBtn: "bg-[#3D5A80] border-[#3D5A80] text-white",
      panelBg: "bg-[#E8EEF8]/95",
      border: "border-[#B8C9E5]",
      inputBg: "bg-white/70",
      accent: "text-[#3D5A80]",
      subAccent: "text-[#91A8D0]"
    },
    'chiikawa-yellow': {
      bg: "bg-[#FFF9D4]", 
      text: "text-[#4D432A]",
      secondaryText: "text-[#7A6F44]",
      glow1: "bg-white/50",
      glow2: "bg-[#FEF5BC]",
      navBg: "bg-white/70",
      cardBg: "bg-white",
      btnBg: "bg-[#96831A] text-white shadow-[0_4px_15px_rgba(150,131,26,0.3)] border-2 border-white/50",
      activeBtn: "bg-[#96831A] border-[#96831A] text-white", 
      panelBg: "bg-[#FFFEF2]/95",
      border: "border-[#E8DE95]",
      inputBg: "bg-white/70",
      accent: "text-[#96831A]",
      subAccent: "text-[#F2E8A8]"
    }
  }[theme];

  const fetchAiInterpretation = async (question, cards, type) => {
    setIsAiLoading(true);
    setAiResponse('');
    const cardInfo = cards.map((c, i) => {
      const pos = type === 'triangle' ? ['過去/原因', '現在/過程', '未來/結果'][i] : '核心建議';
      return `${pos}: ${c.title} (${c.isReversed ? '逆位' : '正位'}) - ${c.meaning}`;
    }).join('\n');

    const prompt = `你是一位專業、溫暖且睿智的塔羅牌大師。
使用者詢問的問題是：「${question || '未提供具體問題，請給予一般性指引'}」
抽出的牌組如下：
${cardInfo}

請針對使用者的問題，結合塔羅牌的象徵意義，提供一段簡潔明確、溫暖大方的解讀。
解讀準則：
1. 如果結果積極正向，請給予鼓勵。
2. 如果結果負面，請包裝成祝福與提醒。
3. 嚴禁 Markdown 符號。語氣親切。`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      setAiResponse(text.replace(/\*\*/g, '').replace(/###/g, ''));
    } catch (error) {
      setAiResponse("宇宙信號目前有些干擾，請參考下方的基本解析。");
    } finally {
      setIsAiLoading(false);
    }
  };

  const drawCards = () => {
    setGameState('shuffling');
    setTimeout(() => {
      const count = spreadType === 'one' ? 1 : 3;
      const shuffled = [...TAROT_DATA].sort(() => Math.random() - 0.5);
      const drawn = shuffled.slice(0, count).map(card => ({
        ...card,
        isReversed: Math.random() > 0.35,
        timestamp: new Date().toLocaleTimeString()
      }));
      setSelectedCards(drawn);
      setGameState('revealed');
      fetchAiInterpretation(userQuestion, drawn, spreadType);
      setHistory(prev => [{ cards: drawn, question: userQuestion || '一般指引', type: spreadType, time: new Date().toLocaleString(), themeAtTime: theme }, ...prev].slice(0, 10));
    }, 2000);
  };

  const resetGame = () => {
    setGameState('idle');
    setSelectedCards([]);
    setAiResponse('');
    setUserQuestion('');
    setIsShareMode(false);
  };

  const TarotCard = ({ card, positionLabel, size = "large" }) => {
    const isLarge = size === "large";
    const isChiikawaMode = theme.startsWith('chiikawa');
    return (
      <div className="flex flex-col items-center space-y-4 animate-in fade-in zoom-in duration-700">
        {positionLabel && (
          <span className={`px-4 py-1 ${isChiikawaMode ? 'bg-white/90 shadow-sm' : (theme === 'night' ? 'bg-indigo-500/10 text-indigo-300' : 'bg-orange-500/10 text-orange-700')} text-[10px] font-bold rounded-full border ${themeStyles.border} tracking-widest uppercase ${isChiikawaMode ? themeStyles.text : ''}`}>
            {positionLabel}
          </span>
        )}
        <div className={`relative ${isLarge ? 'w-48 h-80' : 'w-36 h-60'} rounded-xl p-1 ${isChiikawaMode ? 'bg-gradient-to-br from-white via-white/50 to-white/10' : (theme === 'night' ? 'bg-gradient-to-b from-amber-400/50 to-purple-600/50' : 'bg-gradient-to-b from-orange-400/50 to-amber-200/50')} shadow-2xl transition-transform duration-700 ${card.isReversed ? 'rotate-180' : ''}`}>
          <div className={`w-full h-full ${themeStyles.cardBg} rounded-lg flex flex-col items-center justify-between p-3 relative overflow-hidden transition-colors duration-1000`}>
            {isChiikawaMode && <div className="absolute inset-0 opacity-[0.03] pointer-events-none flex items-center justify-center"><Heart className="w-24 h-24" /></div>}
            <div className={`text-base font-serif ${isChiikawaMode ? 'opacity-30' : (theme === 'night' ? 'text-amber-200/50' : 'text-orange-800/50')}`}>{card.numeral}</div>
            <div className="flex-1 w-full flex flex-col items-center justify-center z-10 space-y-2">
                {isChiikawaMode ? (
                   <div className="w-full h-40 bg-white/50 rounded-md overflow-hidden flex items-center justify-center border border-white/50 shadow-inner">
                      <img src={CHIIKAWA_IMAGES[card.id]} alt={card.title} className="w-full h-full object-contain" />
                   </div>
                ) : (
                  <div className={`p-4 rounded-full ${theme === 'night' ? 'bg-slate-800' : 'bg-amber-100'}`}>
                    {card.id === 19 ? <Sun className="w-8 h-8 text-amber-400" /> : card.id === 18 ? <Moon className="w-8 h-8 text-indigo-300" /> : <Star className="w-8 h-8 text-purple-400" />}
                  </div>
                )}
                <div className="text-center">
                    <div className={`text-lg font-bold tracking-widest ${themeStyles.text}`}>{card.title}</div>
                    <div className={`text-[7px] ${isChiikawaMode ? 'opacity-50' : 'text-indigo-400/70'} uppercase font-bold`}>{card.french}</div>
                </div>
            </div>
            <div className={`text-[9px] font-mono uppercase tracking-tighter ${isChiikawaMode ? 'opacity-20' : 'text-slate-600'}`}>{card.essence}</div>
          </div>
        </div>
        {card.isReversed && (
          <span className={`text-[9px] px-3 py-1 rounded-full border ${isChiikawaMode ? 'bg-white/80 text-rose-500 border-rose-200 shadow-sm' : (theme === 'night' ? 'bg-red-900/40 text-red-400 border-red-500/30' : 'bg-red-100 text-red-700 border-red-200')} font-bold tracking-widest uppercase`}>逆位</span>
        )}
      </div>
    );
  };

  if (isShareMode) {
    return (
      <div className={`min-h-screen ${themeStyles.bg} flex flex-col items-center p-6 text-center animate-in fade-in duration-500 transition-colors duration-1000`}>
        <div className={`w-full max-w-md ${themeStyles.panelBg} border ${themeStyles.border} rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden transition-colors duration-1000`}>
            <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${isChiikawa ? 'from-white via-white/60 to-white/20' : 'from-amber-500 via-indigo-500 to-purple-500'}`} />
            <header className="mb-6">
                <h1 className={`text-2xl font-serif font-bold ${themeStyles.text} mb-1 transition-colors duration-1000`}>
                    {isChiikawa ? '阿爾克納 & Chiikawa' : '大阿爾克那啟示'}
                </h1>
                <p className={`text-[10px] ${themeStyles.secondaryText} tracking-[0.3em] uppercase opacity-60`}>Fate & Wisdom Oracle</p>
            </header>
            <div className="flex justify-center gap-3 mb-6 flex-wrap">
                {selectedCards.map((c, i) => (
                    <div key={i} className={`flex flex-col items-center gap-2 ${c.isReversed ? 'rotate-180' : ''}`}>
                        <div className={`w-28 h-44 ${themeStyles.cardBg} border ${themeStyles.border} rounded-lg flex flex-col items-center justify-between p-2 shadow-lg transition-colors duration-1000`}>
                            <div className={`${themeStyles.text} opacity-20 text-[10px] font-serif`}>{c.numeral}</div>
                            {isChiikawa && (
                              <div className="w-full h-24 bg-white/30 rounded overflow-hidden flex items-center justify-center">
                                <img src={CHIIKAWA_IMAGES[c.id]} alt={c.title} className="w-full h-full object-contain" />
                              </div>
                            )}
                            <div className="text-center">
                                <div className={`${themeStyles.text} font-bold text-sm`}>{c.title}</div>
                                <div className={`text-[6px] ${themeStyles.text} opacity-40 uppercase tracking-tighter`}>{c.french}</div>
                            </div>
                            <div className="text-[7px] text-slate-500 font-mono tracking-widest opacity-40">{c.essence}</div>
                        </div>
                    </div>
                ))}
            </div>
            <div className="text-left space-y-5 mb-6">
                <div className="px-2">
                    <span className={`text-[9px] ${themeStyles.secondaryText} font-bold tracking-widest uppercase block mb-1`}>您的問題</span>
                    <p className={`text-sm ${themeStyles.text} opacity-80 italic`}>「{userQuestion || '宇宙的當前指引'}」</p>
                </div>
                <div className={`h-px ${themeStyles.border} opacity-50`} />
                <div className="px-2">
                    <span className={`text-[9px] ${themeStyles.text} font-bold tracking-widest uppercase block mb-1`}>智慧解讀</span>
                    <p className={`text-xs ${themeStyles.text} opacity-70 leading-relaxed text-justify whitespace-pre-wrap`}>{aiResponse || '正在感應智慧中...'}</p>
                </div>
            </div>
            <footer className="pt-4 border-t ${themeStyles.border} flex justify-between items-center opacity-40">
                <div className="text-[7px] ${themeStyles.text} font-mono tracking-tighter uppercase">{isChiikawa ? 'CHIIKAWA EDITION' : 'ARCANUM SYSTEM'}</div>
                <div className="text-[9px] ${themeStyles.text} italic tracking-widest">截圖保存這份祝福</div>
            </footer>
        </div>
        <button onClick={() => setIsShareMode(false)} className="mt-8 flex items-center gap-2 text-white/50 hover:text-white transition-all text-sm uppercase tracking-widest">
            <X className="w-4 h-4" /> 返回
        </button>
      </div>
    );
  }

  return (
    <div className={`min-h-screen ${themeStyles.bg} ${themeStyles.text} font-sans selection:bg-white/30 overflow-x-hidden transition-colors duration-1000 pb-24`}>
      {/* 背景光暈 */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none opacity-20">
        <div className={`absolute top-[-10%] left-[-10%] w-[80%] h-[40%] ${themeStyles.glow1} rounded-full blur-[120px] transition-colors duration-1000`} />
        <div className={`absolute bottom-[-10%] right-[-10%] w-[80%] h-[40%] ${themeStyles.glow2} rounded-full blur-[120px] transition-colors duration-1000`} />
      </div>

      <div className="relative z-10 max-lg mx-auto px-6 py-8">
        <header className="flex justify-between items-center mb-10">
            <div className="flex items-center gap-2 cursor-pointer select-none" onClick={handleSecretClick}>
                <div className={`p-2 rounded-xl bg-white/20 transition-colors`}>
                    {isChiikawa ? <Heart className="w-5 h-5 text-white animate-pulse" /> : <Sparkles className={`w-5 h-5 ${theme === 'night' ? 'text-amber-300' : 'text-orange-600'}`} />}
                </div>
                <h1 className="text-xl font-serif font-bold tracking-widest transition-colors duration-1000">
                    {isChiikawa ? '阿爾克納 & Chiikawa' : '阿爾克那'}
                </h1>
            </div>
            <div className="flex items-center gap-3">
              {isChiikawa && (
                <button 
                  onClick={returnToClassic} 
                  className={`w-10 h-10 rounded-full flex items-center justify-center border-2 border-white/40 bg-white/20 hover:bg-white/40 transition-all active:scale-90 shadow-md group`}
                  title="返回經典介面"
                >
                  <LogOut className={`w-4 h-4 ${themeStyles.text}`} />
                </button>
              )}
              <button onClick={toggleTheme} className={`w-10 h-10 rounded-full flex items-center justify-center border ${themeStyles.border} ${themeStyles.navBg} transition-all active:scale-90 shadow-lg`}>
                  {isChiikawa ? <Wand2 className="w-5 h-5 opacity-60" /> : (theme === 'night' ? <Moon className="w-5 h-5 text-indigo-300" /> : <Sun className="w-5 h-5 text-orange-500" />)}
              </button>
            </div>
        </header>

        {activeTab === 'divination' && (
          <div className="animate-in fade-in slide-in-from-bottom-4">
            {gameState === 'idle' && (
              <div className="space-y-8">
                <div className="space-y-4">
                    <h2 className="text-4xl font-serif font-bold leading-tight">
                        {isChiikawa ? '嘿！現在，\n想問什麼？' : '現在，\n你想問什麼？'}
                    </h2>
                    <p className={`${themeStyles.secondaryText} text-sm font-light tracking-wide`}>靜下心來，將您的疑惑交給這份智慧。</p>
                </div>

                <div className="space-y-6">
                    <textarea
                        value={userQuestion}
                        onChange={(e) => setUserQuestion(e.target.value)}
                        placeholder="在此輸入您的問題..."
                        className={`w-full h-36 ${themeStyles.inputBg} border ${themeStyles.border} rounded-3xl p-6 ${themeStyles.text} placeholder:opacity-30 focus:outline-none transition-all resize-none shadow-xl text-lg transition-colors duration-1000`}
                    />

                    <div className="flex gap-4">
                        <button 
                            onClick={() => setSpreadType('one')} 
                            className={`flex-1 p-5 rounded-3xl border-2 transition-all text-center group ${spreadType === 'one' ? (isChiikawa ? themeStyles.activeBtn : 'border-indigo-500/50 bg-white/20') + ' shadow-lg scale-[1.02]' : `${themeStyles.border} ${themeStyles.inputBg} opacity-60`}`}
                        >
                            <Compass className={`w-5 h-5 mx-auto mb-2 transition-transform group-hover:rotate-12 ${spreadType === 'one' ? (isChiikawa ? (theme === 'chiikawa-yellow' ? 'text-[#4D432A]' : 'text-white') : themeStyles.text) : 'opacity-30'}`} />
                            <span className={`text-sm font-bold block ${spreadType === 'one' ? (isChiikawa ? (theme === 'chiikawa-yellow' ? 'text-[#4D432A]' : 'text-white') : themeStyles.text) : 'opacity-40'}`}>一牌直覺</span>
                        </button>
                        <button 
                            onClick={() => setSpreadType('triangle')} 
                            className={`flex-1 p-5 rounded-3xl border-2 transition-all text-center group ${spreadType === 'triangle' ? (isChiikawa ? themeStyles.activeBtn : 'border-indigo-500/50 bg-white/20') + ' shadow-lg scale-[1.02]' : `${themeStyles.border} ${themeStyles.inputBg} opacity-60`}`}
                        >
                            <Layout className={`w-5 h-5 mx-auto mb-2 transition-transform group-hover:scale-110 ${spreadType === 'triangle' ? (isChiikawa ? (theme === 'chiikawa-yellow' ? 'text-[#4D432A]' : 'text-white') : themeStyles.text) : 'opacity-30'}`} />
                            <span className={`text-sm font-bold block ${spreadType === 'triangle' ? (isChiikawa ? (theme === 'chiikawa-yellow' ? 'text-[#4D432A]' : 'text-white') : themeStyles.text) : 'opacity-40'}`}>聖三角</span>
                        </button>
                    </div>
                </div>

                <button onClick={drawCards} className={`w-full py-5 ${themeStyles.btnBg} rounded-full font-bold tracking-[0.3em] active:scale-95 transition-all mt-4 uppercase text-lg`}>
                    啟動靈性感應
                </button>
              </div>
            )}

            {gameState === 'shuffling' && (
              <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-12">
                <div className="relative w-40 h-64">
                   {[...Array(5)].map((_, i) => (
                    <div key={i} className={`absolute inset-0 ${themeStyles.cardBg} rounded-xl border-2 ${themeStyles.border} shadow-2xl animate-pulse transition-colors duration-1000`} style={{ transform: `rotate(${i * 6 - 12}deg) translate(${i * 4}px, 0)`, zIndex: i }} />
                   ))}
                </div>
                <div className="text-center space-y-3">
                    <p className={`text-xl font-serif italic ${themeStyles.text} animate-pulse tracking-[0.2em]`}>正在搜尋命運的軌跡...</p>
                    <p className={`text-xs ${themeStyles.secondaryText} uppercase tracking-widest font-mono opacity-60`}>Syncing with {theme.split('-')[0].toUpperCase()}</p>
                </div>
              </div>
            )}

            {gameState === 'revealed' && (
              <div className="space-y-10 animate-in fade-in duration-700">
                <div className="flex flex-wrap justify-center gap-6">
                  {selectedCards.map((card, idx) => <TarotCard key={idx} card={card} positionLabel={spreadType === 'triangle' ? ['過去 / 原因', '現在 / 過程', '未來 / 結果'][idx] : '核心建議'} size={selectedCards.length > 1 ? "medium" : "large"} />)}
                </div>

                <div className="space-y-6">
                    <div className={`${themeStyles.panelBg} rounded-[2.5rem] p-8 border ${themeStyles.border} shadow-2xl backdrop-blur-md transition-colors duration-1000`}>
                        <div className="flex items-center gap-3 mb-6">
                            <BrainCircuit className={`w-5 h-5 ${themeStyles.text} opacity-60`} />
                            <h3 className="text-lg font-bold tracking-widest transition-colors duration-1000">
                                {isChiikawa ? '阿爾克納 & Chiikawa' : '宇宙的溫暖啟示'}
                            </h3>
                        </div>
                        {isAiLoading ? (
                            <div className="flex flex-col items-center py-8 gap-4 text-slate-500 italic text-sm">
                                <Loader2 className={`w-6 h-6 animate-spin ${themeStyles.text} opacity-50`} /> 正在解讀這份靈魂訊息...
                            </div>
                        ) : (
                            <div className={`${themeStyles.text} opacity-90 leading-relaxed text-base font-light text-justify whitespace-pre-wrap transition-colors duration-1000`}>
                                {aiResponse || "靜候啟示降臨..."}
                            </div>
                        )}
                    </div>

                    {selectedCards.map((card, idx) => (
                        <div key={idx} className={`p-7 rounded-[2.5rem] border ${themeStyles.border} ${themeStyles.panelBg} transition-colors duration-1000 shadow-lg`}>
                            <div className="flex justify-between items-center mb-5">
                                <h4 className={`font-bold ${themeStyles.text} flex items-center gap-2`}>
                                    <span className={`w-1.5 h-1.5 ${isChiikawa ? 'bg-current opacity-20' : 'bg-white/50'} rounded-full`} />
                                    {card.title} 基本解析
                                </h4>
                                <span className="text-[9px] opacity-40 uppercase font-mono">{card.astrology}</span>
                            </div>
                            <div className="space-y-5">
                                <div>
                                    <span className="text-[9px] opacity-40 uppercase block mb-1 font-bold tracking-widest font-sans">對應本質</span>
                                    <p className={`text-sm ${themeStyles.text} opacity-80 leading-relaxed transition-colors duration-1000`}>{card.essence}：{card.meaning}</p>
                                </div>
                                <div>
                                    <span className={`text-[9px] uppercase block mb-1 font-bold tracking-widest opacity-60 font-sans`}>
                                        {card.isReversed ? '逆位深度提醒' : '正位能量指引'}
                                    </span>
                                    <p className={`text-sm ${themeStyles.text} opacity-60 leading-relaxed italic transition-colors duration-1000`}>{card.isReversed ? card.reversedInsight : card.uprightInsight}</p>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                {/* 加大按鈕區域 */}
                <div className="flex flex-col gap-5 pt-4">
                    <button onClick={() => setIsShareMode(true)} className={`w-full py-6 ${isChiikawa ? themeStyles.btnBg : 'bg-white/20 hover:bg-white/30 text-white shadow-lg'} rounded-full font-bold flex items-center justify-center gap-3 active:scale-95 transition-all text-lg uppercase tracking-widest shadow-2xl border-2 border-white/20`}>
                        <Share2 className="w-6 h-6" /> 生成這份祝福
                    </button>
                    <button onClick={resetGame} className={`w-full py-5 border-2 ${themeStyles.border} rounded-full text-base font-bold flex items-center justify-center gap-2 active:scale-95 transition-all uppercase tracking-widest opacity-70 ${isChiikawa ? themeStyles.text : 'text-slate-400'} hover:opacity-100`}>
                        <RefreshCw className="w-5 h-5" /> 重新占卜
                    </button>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'guide' && (
            <div className="animate-in fade-in slide-in-from-bottom-4 space-y-8">
                <h2 className={`text-3xl font-serif font-bold tracking-widest ${themeStyles.text} transition-colors duration-1000`}>占卜指南</h2>
                <div className="grid grid-cols-1 gap-5">
                    {[
                        { title: "一牌直覺", desc: "最直接的能量共鳴。當您只需要一個快速的方向或確認時，抽一張牌便能獲得明確的解答。" },
                        { title: "聖三角牌陣", desc: "洞悉事情的來龍去脈。三張牌分別解讀過去的根源、現在的處境與未來的潛在發展方向。" },
                        { title: "能量轉化", desc: "即使抽到逆位或困難的牌，也代表著一種提醒。這份系統會將其轉化為建設性的祝福，幫助您避開障礙。" }
                    ].map((item, i) => (
                        <div key={i} className={`${themeStyles.panelBg} p-8 rounded-[2rem] border ${themeStyles.border} shadow-lg transition-colors duration-1000`}>
                            <h3 className={`font-bold text-lg mb-3 flex items-center gap-2 ${themeStyles.text} transition-colors duration-1000`}>
                                <span className={`w-2 h-2 ${isChiikawa ? 'bg-current opacity-30' : 'bg-white/30'} rounded-full`} />
                                {item.title}
                            </h3>
                            <p className={`text-sm ${themeStyles.text} opacity-60 leading-relaxed font-light transition-colors duration-1000`}>{item.desc}</p>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {activeTab === 'history' && (
            <div className="animate-in fade-in slide-in-from-bottom-4 space-y-6">
                <h2 className={`text-3xl font-serif font-bold tracking-widest ${themeStyles.text} transition-colors duration-1000`}>啟示紀錄</h2>
                {history.length === 0 ? (
                    <div className="py-24 text-center opacity-30 italic text-sm uppercase tracking-[0.3em]">時間尚無刻痕</div>
                ) : history.map((h, i) => (
                    <div key={i} className={`${themeStyles.panelBg} p-6 rounded-3xl border ${themeStyles.border} flex justify-between items-center shadow-md transition-colors duration-1000`}>
                        <div className="space-y-1.5">
                            <p className={`text-sm font-bold ${themeStyles.text} truncate max-w-[140px] transition-colors duration-1000`}>「{h.question}」</p>
                            <p className="text-[9px] opacity-40 font-mono">{h.time}</p>
                        </div>
                        <div className="flex gap-1.5">
                            {h.cards.map((c, j) => <div key={j} className={`w-7 h-11 bg-black/10 border ${themeStyles.border} rounded-md flex items-center justify-center text-[9px] font-serif shadow-sm`}>{c.numeral}</div>)}
                        </div>
                    </div>
                ))}
            </div>
        )}
      </div>

      <nav className={`fixed bottom-0 left-0 w-full ${themeStyles.navBg} backdrop-blur-2xl border-t ${themeStyles.border} px-8 py-5 flex justify-around items-center z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.1)] transition-colors duration-1000`}>
          <button onClick={() => setActiveTab('divination')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'divination' ? 'opacity-100 scale-110' : 'opacity-30'}`}>
              <Sparkles className="w-6 h-6" />
              <span className="text-[10px] font-bold uppercase tracking-widest font-sans">占卜</span>
          </button>
          <button onClick={() => setActiveTab('guide')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'guide' ? 'opacity-100 scale-110' : 'opacity-30'}`}>
              <BookOpen className="w-6 h-6" />
              <span className="text-[10px] font-bold uppercase tracking-widest font-sans">指南</span>
          </button>
          <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'history' ? 'opacity-100 scale-110' : 'opacity-30'}`}>
              <History className="w-6 h-6" />
              <span className="text-[10px] font-bold uppercase tracking-widest font-sans">紀錄</span>
          </button>
      </nav>

      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; transition: background-color 1s ease; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .transition-colors { transition-duration: 1000ms; }
        ::-webkit-scrollbar { display: none; }
      `}} />
    </div>
  );
};

export default App;
