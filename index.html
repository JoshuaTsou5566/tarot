<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>大阿爾克納 - 塔羅占卜</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; transition: background-color 0.8s ease; margin: 0; padding: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        ::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-press:active { transform: scale(0.92); transition: transform 0.1s; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .decoration-layer { pointer-events: none; z-index: -1; }
        input { font-size: 16px !important; }
    </style>
</head>
<body class="bg-[#020617]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 加密與解密小工具 ---
        const encodeKey = (key, pass) => {
            const combined = key + "|" + pass;
            return btoa(unescape(encodeURIComponent(combined)));
        };
        const decodeKey = (encoded) => {
            try {
                const decoded = decodeURIComponent(escape(atob(encoded)));
                const [key, pass] = decoded.split('|');
                return { key, pass };
            } catch (e) { return null; }
        };

        // --- SVG 圖示定義 ---
        const ICONS = {
            Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></>,
            RefreshCw: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>,
            Moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>,
            Sun: <><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.11 1.11"/><path d="M19.07 4.93l-1.41 1.41"/></>,
            BookOpen: <><path d="M2 3h6a4 4 0 0 1 4 4v14a4 4 0 0 0-4-4H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a4 4 0 0 1 4-4h6z"/></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            X: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>,
            Share: <><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></>,
            Compass: <><circle cx="12" cy="12" r="10"/><path d="m16.24 7.76-2.12 6.36-6.36 2.12 2.12-6.36 6.36-2.12z"/></>,
            Layout: <><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></>,
            BrainCircuit: <><path d="M12 4.5V2"/><path d="M18 11h2.5"/><path d="M12 19.5V22"/><path d="M5.5 11H3"/><path d="M12 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/><path d="M16 12.5V11a4 4 0 0 0-8 0v1.5"/><path d="M16 8a4 4 0 0 0-8 0"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
            // --- 強化辨識度的剪影 ---
            ChiikawaSilhouette: <path d="M12 22C6.5 22 2 18 2 12.5C2 9 4 6 7 5 V 2 A 1.5 1.5 0 0 1 11 2v2c.3-.1.6-.1.9-.1s.7 0 1 .1V2a1.5 1.5 0 0 1 3 0v2.5c3.5 1 6 4 6 7.5 0 5.5-4.5 10-10 10z" fill="currentColor" />,
            HachiwareSilhouette: <path d="M12 22c-5 0-9-4-9-9 0-3.5 2-6.5 5-7.5 L 4.5 1 L 8 0 L 10 3.5 C 10.5 3.5 11.5 3.3 12 3.3 S 13.5 4 14 4 L 16 1 L 19.5 2 L 19 5 C 21 6 22 9 22 12.5 22 18 18 22 12 22 Z M 10 9 L 12 11 L 14 9" fill="currentColor" />,
            UsagiSilhouette: <path d="M12 22c-5 0-9-4-9-9 0-4 1.5-7.5 4-8.5 V 0 a 1 1 0 0 1 2 0 v 4 c 1 -.1 2 -.2 3 -.2 s 2 .1 3 .2 v -4 a 1 1 0 0 1 2 0 v 4.5 c 2.5 1 4 4.5 4 8.5 0 5 -4 9 -9 9 Z" fill="currentColor" />
        };

        const Icon = ({ name, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {ICONS[name] || null}
            </svg>
        );

        const TAROT_DATA = [
            { id: 0, numeral: "0", title: "愚者", meaning: "開端與冒險", insight: "全新的開始，勇敢踏出冒險的第一步。信任宇宙，前方有無限可能。" },
            { id: 1, numeral: "I", title: "魔術師", meaning: "創造與能力", insight: "你已具備成功工具，現在正是實踐想法的時刻。展現你的才華吧。" },
            { id: 2, numeral: "II", title: "女祭司", meaning: "直覺與神秘", insight: "深度連結直覺，靜待真相浮現。保持內心的寧靜與冷靜。" },
            { id: 3, numeral: "III", title: "皇后", meaning: "豐收與生命力", insight: "生命充滿恩惠與溫柔，正是享受生活與創造的時刻。" },
            { id: 4, numeral: "IV", title: "皇帝", meaning: "秩序與權威", insight: "展現領導力，建立穩定結構。這是一個掌握掌控權的時期。" },
            { id: 5, numeral: "V", title: "教皇", meaning: "知識與傳統", insight: "尋求智慧引導，遵循正統價值。適合向專業人士諮詢。" },
            { id: 6, numeral: "VI", title: "戀人", meaning: "祝福與契合", insight: "完美契合的關係，面臨忠於心靈的選擇。信任你的心。" },
            { id: 7, numeral: "VII", title: "戰車", meaning: "意志與勝利", insight: "意志堅定，以行動力克服困難。這是一場必定勝利的遠征。" },
            { id: 8, numeral: "VIII", title: "力量", meaning: "勇氣與堅韌", insight: "以柔克剛，展現內在不屈的慈悲與強韌。你比想像中更強大。" },
            { id: 9, numeral: "IX", title: "隱者", meaning: "內省與智慧", insight: "向內探索，在孤獨中遇見真實的自我。你需要一段寧靜的時光。" },
            { id: 10, numeral: "X", title: "命運之輪", meaning: "週期與轉機", insight: "轉機降臨，命運齒輪正帶領你前進。接受變動與好運。" },
            { id: 11, numeral: "XI", title: "正義", meaning: "公平與客觀", insight: "誠實無私，事物朝向平衡發展。真相將會大白。" },
            { id: 12, numeral: "XII", title: "倒吊人", meaning: "犧牲與覺醒", insight: "換個角度看世界。暫時的靜止是為了換取更高的覺醒。" },
            { id: 13, numeral: "XIII", title: "死神", meaning: "終結與轉化", insight: "捨棄舊模式，迎接新生。結束是另一個偉大開始的序幕。" },
            { id: 14, numeral: "XIV", title: "節制", meaning: "平衡與調和", insight: "融合不同元素，保持平和。事物正以和諧的節奏趨於完美。" },
            { id: 15, numeral: "XV", title: "惡魔", meaning: "慾望與制約", insight: "覺察束縛你的物質執迷。意識到問題是解脫的第一步。" },
            { id: 16, numeral: "XVI", title: "塔", meaning: "劇變與啟示", insight: "劇烈瓦解虛偽，真相在廢墟中顯現。這是一個必要的重整。" },
            { id: 17, numeral: "XVII", title: "星星", meaning: "希望與療癒", insight: "希望湧現，心靈獲得寧靜療癒。跟隨那道引導的光芒。" },
            { id: 18, numeral: "XVIII", title: "月亮", meaning: "不安與潛意識", insight: "警惕幻覺，傾聽潛意識引導。真相隱藏在迷霧之後。" },
            { id: 19, numeral: "XIX", title: "太陽", meaning: "光明與成功", insight: "成功在望，喜悅圓滿。這是一個充滿活力與榮耀的時刻。" },
            { id: 20, numeral: "XX", title: "審判", meaning: "復活與感召", insight: "靈魂覺醒，原諒過去。這是一個邁向生命新階段的時刻。" },
            { id: 21, numeral: "XXI", title: "世界", meaning: "完美與圓滿", insight: "旅程功德圓滿，完美的整合。祝賀你達成心願。" }
        ];

        const CHIIKAWA_IMAGES = {
            0: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/0.jpg",
            1: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/1.jpg",
            2: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/2.jpg",
            3: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/3.jpg",
            4: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/4.jpg",
            5: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/5.jpg",
            6: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/6.jpg",
            7: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/7.jpg",
            8: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/8.jpg",
            9: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/9.jpg",
            10: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/10.jpg",
            11: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/11.jpg",
            12: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/12.jpg",
            13: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/13.jpg",
            14: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/14.jpg",
            15: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/15.jpg",
            16: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/16.jpg",
            17: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/17.jpg",
            18: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/18.jpg",
            19: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/19.jpg",
            20: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/20.jpg",
            21: "https://raw.githubusercontent.com/JoshuaTsou5566/tarot/refs/heads/main/21.jpg"
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('divination');
            const [theme, setTheme] = useState('night');
            const [gameState, setGameState] = useState('idle');
            const [spreadType, setSpreadType] = useState('one');
            const [userQuestion, setUserQuestion] = useState('');
            const [selectedCards, setSelectedCards] = useState([]);
            const [aiResponse, setAiResponse] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [secretClickCount, setSecretClickCount] = useState(0);
            
            const [isSetupVisible, setIsSetupVisible] = useState(false);
            const [unlockInput, setUnlockInput] = useState('');
            const [masterApiKey, setMasterApiKey] = useState(localStorage.getItem('arcanum_master_key') || '');
            const [masterPass, setMasterPass] = useState(localStorage.getItem('arcanum_master_pass') || '');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [zoomedImage, setZoomedImage] = useState(null);

            // 檢查授權連結
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const data = params.get('auth');
                if (data) {
                    const result = decodeKey(data);
                    if (result) {
                        localStorage.setItem('arcanum_master_key', result.key);
                        localStorage.setItem('arcanum_master_pass', result.pass);
                        setMasterApiKey(result.key);
                        setMasterPass(result.pass);
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert("授權連結已生效！現在您可以輸入密碼開始占卜。");
                    }
                }
            }, []);

            const toggleTheme = () => {
                if (theme === 'chiikawa-pink') setTheme('chiikawa-blue');
                else if (theme === 'chiikawa-blue') setTheme('chiikawa-yellow');
                else if (theme === 'chiikawa-yellow') setTheme('chiikawa-pink');
                else setTheme(prev => prev === 'night' ? 'day' : 'night');
            };

            const isChiikawa = theme.startsWith('chiikawa');
            const themeStyles = useMemo(() => {
                const styles = {
                    night: { bg: "bg-[#020617]", text: "text-slate-100", secondaryText: "text-slate-400", glow1: "bg-indigo-900", glow2: "bg-purple-900", navBg: "bg-slate-900/80", cardBg: "bg-slate-900", btnBg: "bg-white text-slate-950", border: "border-white/10", accent: "#818cf8" },
                    day: { bg: "bg-[#fffbeb]", text: "text-slate-800", secondaryText: "text-slate-500", glow1: "bg-amber-200", glow2: "bg-orange-200", navBg: "bg-white/80", cardBg: "bg-white", btnBg: "bg-slate-900 text-white", border: "border-amber-900/10", accent: "#ea580c" },
                    'chiikawa-pink': { bg: "bg-[#EFA5C9]", text: "text-[#5D2E46]", glow1: "bg-white/40", glow2: "bg-[#FADDE9]", navBg: "bg-white/70", cardBg: "bg-white", btnBg: "bg-[#D64E8B] text-white shadow-lg", border: "border-[#F4C1D9]", accent: "#D64E8B" },
                    'chiikawa-blue': { bg: "bg-[#91A8D0]", text: "text-[#1B2A4E]", glow1: "bg-white/40", glow2: "bg-[#D1DCEE]", navBg: "bg-white/70", cardBg: "bg-white", btnBg: "bg-[#3D5A80] text-white shadow-lg", border: "border-[#B8C9E5]", accent: "#3D5A80" },
                    'chiikawa-yellow': { bg: "bg-[#FFF9D4]", text: "text-[#4D432A]", glow1: "bg-white/50", glow2: "bg-[#FEF5BC]", navBg: "bg-white/70", cardBg: "bg-white", btnBg: "bg-[#96831A] text-white shadow-lg border-2 border-white/50", border: "border-[#E8DE95]", accent: "#96831A" }
                };
                return styles[theme];
            }, [theme]);

            const fetchInterpretation = async (cards) => {
                if (!masterApiKey) return;
                setIsAiLoading(true);
                const details = cards.map(c => `${c.title}(${c.isReversed?'逆位':'正位'})`).join(',');
                const prompt = `你是一位專業塔羅大師。問題：${userQuestion || '求引'}。牌組：${details}。請給予約300字暖心建議。嚴禁使用 Markdown。`;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${masterApiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    setAiResponse(data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/[*#]/g, '').trim() || "啟示正在星圖中形成...");
                } catch (e) { setAiResponse("宇宙能量傳輸稍有延遲，請稍後再試。"); }
                finally { setIsAiLoading(false); }
            };

            const drawCards = () => {
                setIsAuthenticated(false);
                setAiResponse('');
                setGameState('shuffling');
                setTimeout(() => {
                    const count = spreadType === 'one' ? 1 : 3;
                    const drawn = [...TAROT_DATA].sort(() => Math.random() - 0.5).slice(0, count).map(c => ({
                        ...c, isReversed: Math.random() > 0.35
                    }));
                    setSelectedCards(drawn);
                    setGameState('revealed');
                }, 1500);
            };

            const handleUnlock = () => {
                if (!masterPass) { alert("此裝置尚未授權，請在原始設定裝置點擊「生成授權分享連結」傳過來點開。"); return; }
                if (unlockInput.trim() === masterPass) {
                    setIsAuthenticated(true);
                    fetchInterpretation(selectedCards);
                } else { alert("解鎖密碼錯誤。"); }
            };

            const generateLink = () => {
                if (!masterApiKey || !masterPass) { alert("請先填寫 API 金鑰與密碼並儲存。"); return; }
                const encrypted = encodeKey(masterApiKey, masterPass);
                const url = `${window.location.origin}${window.location.pathname}?auth=${encrypted}`;
                const el = document.createElement('textarea');
                el.value = url; document.body.appendChild(el); el.select();
                document.execCommand('copy'); document.body.removeChild(el);
                alert("授權分享連結已複製！傳給手機開啟一次後，手機即可具備解鎖能力。");
            };

            const handleSaveMaster = () => {
                if (masterApiKey && masterPass) {
                    localStorage.setItem('arcanum_master_key', masterApiKey);
                    localStorage.setItem('arcanum_master_pass', masterPass);
                    setIsSetupVisible(false);
                    alert("管理設定儲存成功！");
                } else {
                    alert("請填寫完整資訊");
                }
            };

            // --- 內部的指南頁面組件 ---
            const GuidePage = () => {
                const [expandedId, setExpandedId] = useState(null);
                return (
                    <div className="animate-in space-y-8 pb-10">
                        <h2 className="text-3xl font-serif font-bold tracking-widest transition-colors duration-1000">占卜指南</h2>
                        <div className="space-y-4">
                            <div className="glass-panel p-6 rounded-[2rem]">
                                <p className="font-bold text-indigo-400 mb-2 font-serif tracking-widest uppercase text-sm">Cloud Share</p>
                                <p className="text-[11px] opacity-70 leading-relaxed text-justify italic">管理員在原始裝置完成「雲端設定」後，點擊下方按鈕生成連結傳給親友。親友手機開啟連結後即可永久連線資料庫，無須重複設定。</p>
                                <button onClick={generateLink} className="mt-4 flex items-center gap-2 px-5 py-2.5 bg-indigo-500/20 border border-indigo-500/30 rounded-full text-[10px] font-bold active:scale-95 transition-all"><Icon name="Share" size={12} /> 生成親友授權連結</button>
                            </div>
                        </div>
                        <div className="space-y-8">
                            <section className="space-y-4">
                                <h3 className="font-bold text-lg opacity-80 border-l-4 border-rose-500 pl-3 transition-colors duration-1000">22 張大阿爾克那圖鑑</h3>
                                <div className="space-y-2">
                                    {TAROT_DATA.map(c => (
                                        <div key={c.id} className="border border-white/5 rounded-2xl overflow-hidden glass-panel">
                                            <button onClick={() => setExpandedId(expandedId === c.id ? null : c.id)} className="w-full flex items-center justify-between p-5 text-left transition-colors hover:bg-white/5">
                                                <div className="flex items-center gap-4"><span className="font-mono text-xs opacity-40">{c.numeral}</span><span className="font-bold tracking-widest">{c.title}</span></div>
                                                <Icon name="ChevronDown" size={16} className={`transition-transform ${expandedId === c.id ? 'rotate-180' : ''}`} />
                                            </button>
                                            {expandedId === c.id && (
                                                <div className="p-6 bg-black/20 text-xs space-y-4 animate-in text-justify">
                                                    <p className="opacity-80 font-bold">{c.meaning}</p>
                                                    <p className="opacity-60 italic leading-relaxed">{c.uprightInsight}</p>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </section>
                            <button onClick={() => setIsSetupVisible(true)} className="w-full py-4 border border-dashed border-white/20 rounded-2xl opacity-40 text-xs hover:opacity-100 transition-all font-bold uppercase tracking-[0.2em]">管理員加密設定</button>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen ${themeStyles.bg} ${themeStyles.text} transition-colors duration-1000 pb-32 relative`}>
                    <div className="decoration-layer fixed inset-0 overflow-hidden opacity-20">
                        <div className={`absolute top-[-10%] left-[-10%] w-[80%] h-[40%] ${themeStyles.glow1} rounded-full blur-[120px] transition-colors duration-1000`} />
                        <div className={`absolute bottom-[-10%] right-[-10%] w-[80%] h-[40%] ${themeStyles.glow2} rounded-full blur-[120px] transition-colors duration-1000`} />
                    </div>

                    <div className="relative z-10 max-w-lg mx-auto px-6 py-10">
                        <header className="flex justify-between items-center mb-12">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => {
                                const next = secretClickCount + 1;
                                if (next >= 5) { setTheme('chiikawa-pink'); setSecretClickCount(0); }
                                else setSecretClickCount(next);
                            }}>
                                <div className="p-2 rounded-xl bg-white/20">
                                    <Icon name={isChiikawa ? "Heart" : "Sparkles"} className={isChiikawa ? "animate-pulse text-white" : "text-amber-300"} />
                                </div>
                                <h1 className="text-xl font-serif font-bold tracking-widest">{isChiikawa ? "阿爾克納 & Chiikawa" : "大阿爾克納 - 塔羅占卜"}</h1>
                            </div>
                            <div className="flex gap-2">
                                {isChiikawa && <button onClick={returnToClassic} className="w-10 h-10 rounded-full flex items-center justify-center border bg-white/10 shadow-sm btn-press transition-all"><Icon name="LogOut" size={16} /></button>}
                                <button onClick={toggleTheme} className="w-12 h-12 rounded-full flex items-center justify-center border bg-white/10 shadow-sm btn-press transition-all">
                                    {theme === 'chiikawa-pink' ? <Icon name="ChiikawaSilhouette" size={28} /> :
                                     theme === 'chiikawa-blue' ? <Icon name="HachiwareSilhouette" size={28} /> :
                                     theme === 'chiikawa-yellow' ? <Icon name="UsagiSilhouette" size={28} /> :
                                     (theme === 'night' ? <Icon name="Moon" size={20} /> : <Icon name="Sun" size={20} />)}
                                </button>
                            </div>
                        </header>

                        {activeTab === 'divination' && (
                            <div className="animate-in">
                                {gameState === 'idle' && (
                                    <div className="space-y-10">
                                        <h2 className="text-4xl font-serif font-bold leading-tight">現在，你想問什麼？</h2>
                                        <textarea value={userQuestion} onChange={e=>setUserQuestion(e.target.value)} placeholder="在此輸入您的疑惑..." className="w-full h-40 bg-white/5 border border-white/10 rounded-[2rem] p-6 focus:outline-none transition-all resize-none shadow-xl text-lg placeholder:opacity-30" />
                                        <div className="flex gap-4">
                                            <button onClick={()=>setSpreadType('one')} className={`flex-1 p-6 rounded-3xl border-2 transition-all ${spreadType==='one' ? 'border-indigo-400 bg-white/10' : 'border-white/5 opacity-40'}`}><Icon name="Compass" className="mx-auto mb-2 opacity-50" /><span className="text-sm font-bold block uppercase tracking-widest">一牌直覺</span></button>
                                            <button onClick={()=>setSpreadType('triangle')} className={`flex-1 p-6 rounded-3xl border-2 transition-all ${spreadType==='triangle' ? 'border-indigo-400 bg-white/10' : 'border-white/5 opacity-40'}`}><Icon name="Layout" className="mx-auto mb-2 opacity-50" /><span className="text-sm font-bold block uppercase tracking-widest">聖三角</span></button>
                                        </div>
                                        <button onClick={drawCards} className={`w-full py-6 ${themeStyles.btnBg} rounded-full font-bold tracking-[0.3em] shadow-2xl active:scale-95 transition-all text-xl uppercase transition-colors duration-1000`}>啟動靈性感應</button>
                                    </div>
                                )}

                                {gameState === 'shuffling' && (
                                    <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-8"><div className="w-32 h-48 bg-white/10 rounded-xl border-2 border-white/20 animate-pulse" /><p className="text-xl font-serif italic animate-bounce tracking-widest">正在搜尋命運軌跡...</p></div>
                                )}

                                {gameState === 'revealed' && (
                                    <div className="space-y-12 animate-in pb-10">
                                        <div className="flex flex-wrap justify-center gap-6">
                                            {selectedCards.map((c, i) => (
                                                <div key={i} className="flex flex-col items-center gap-4">
                                                    <div className={`relative w-44 h-72 rounded-xl p-0.5 bg-gradient-to-br from-white/80 to-white/20 shadow-2xl ${c.isReversed ? 'rotate-180' : ''}`}>
                                                        <div className={`w-full h-full ${themeStyles.cardBg} rounded-lg flex flex-col items-center justify-between relative overflow-hidden transition-colors duration-1000`}>
                                                            <div className="absolute top-2 left-3 text-[10px] opacity-30 font-serif z-10">{c.numeral}</div>
                                                            <div className="flex-1 w-full relative group">
                                                                {isChiikawa ? (
                                                                    <div className="w-full h-full flex items-center justify-center p-2"><img src={CHIIKAWA_IMAGES[c.id]} className="w-full h-full object-contain opacity-90 transition-all hover:scale-105" alt={c.title} /></div>
                                                                ) : (
                                                                    <div className="w-full h-full flex flex-col items-center justify-center space-y-3 pt-6 transition-colors duration-1000"><Icon name={c.id === 19 ? "Sun" : (c.id === 18 ? "Moon" : "Star")} size={48} className="opacity-30" /><div className="text-center font-bold tracking-widest transition-colors duration-1000">{c.title}</div></div>
                                                                )}
                                                            </div>
                                                            <div className={`w-full py-2 px-3 text-center z-10 ${isChiikawa ? 'bg-black/60 backdrop-blur-md' : ''}`}>
                                                                {isChiikawa && <div className="text-[11px] font-bold tracking-widest text-white">{c.title}</div>}
                                                                <div className={`text-[8px] uppercase font-mono tracking-tighter ${isChiikawa ? 'text-white/50' : 'opacity-20'}`}>TAROT ORACLE</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <span className="text-[10px] uppercase opacity-60 font-bold tracking-widest">{c.isReversed ? '逆位' : '正位'}</span>
                                                </div>
                                            ))}
                                        </div>

                                        <div className="space-y-6">
                                            <div className="glass-panel rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden transition-colors duration-1000 min-h-[350px]">
                                                <div className="flex items-center gap-3 mb-8 opacity-60 font-bold tracking-widest uppercase italic transition-colors duration-1000"><Icon name="BrainCircuit" size={20} />宇宙的深層啟示</div>
                                                {isAiLoading ? (<div className="flex flex-col items-center justify-center py-20 gap-4 text-center transition-colors duration-1000"><Icon name="RefreshCw" className="animate-spin opacity-30" size={32} /><p className="animate-pulse text-sm opacity-40 tracking-widest font-serif">同步中...</p></div>) : aiResponse ? (
                                                    <div className="leading-relaxed font-light text-justify whitespace-pre-wrap text-base animate-in transition-colors duration-1000">{aiResponse}</div>
                                                ) : !isAuthenticated ? (
                                                    <div className="py-10 flex flex-col items-center gap-6">
                                                        <Icon name="Lock" size={40} className="opacity-20" />
                                                        <div className="text-center space-y-2 mb-6"><p className="text-sm opacity-50 transition-colors duration-1000">啟示內容已鎖定</p><p className="text-[10px] opacity-30 uppercase transition-colors duration-1000">請輸入解鎖密碼</p></div>
                                                        {/* 手機直式排列優化 */}
                                                        <div className="flex flex-col w-full gap-5 px-4 max-w-xs mb-12">
                                                            <input type="text" value={unlockInput} onChange={e=>setUnlockInput(e.target.value)} placeholder="訪問密碼" className="w-full bg-white/5 border border-white/10 rounded-xl p-5 text-center text-sm focus:outline-none focus:border-indigo-400 shadow-inner" />
                                                            <button onClick={handleUnlock} className="w-full py-5 bg-white text-slate-900 rounded-xl font-bold text-xs shadow-xl active:bg-indigo-50 uppercase tracking-widest transition-all">解鎖啟示內容</button>
                                                        </div>
                                                    </div>
                                                ) : <div className="text-center py-20 opacity-30 italic text-sm">連線中...</div>}
                                            </div>
                                            {selectedCards.map((c, i) => (
                                                <div key={i} className={`p-7 rounded-[2.5rem] border ${themeStyles.border} bg-white/5 text-sm space-y-4 shadow-md transition-colors duration-1000 animate-in`} style={{animationDelay: `${i*100}ms`}}>
                                                    <h4 className="font-bold flex items-center gap-2"><span className="w-1.5 h-1.5 bg-current opacity-20 rounded-full" />{c.title} 基本解析</h4>
                                                    <p className="opacity-80 leading-relaxed text-justify transition-colors duration-1000">{c.insight}</p>
                                                </div>
                                            ))}
                                            <button onClick={resetGame} className="w-full py-5 border-2 border-white/10 rounded-full text-sm font-bold flex items-center justify-center gap-2 opacity-60 transition-colors duration-1000"><Icon name="RefreshCw" size={16} /> 重新占卜</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'guide' && <GuidePage />}
                    </div>

                    <nav className={`fixed bottom-0 left-0 w-full ${themeStyles.navBg} backdrop-blur-2xl border-t ${themeStyles.border} px-16 py-6 flex justify-around items-center z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.2)] transition-colors duration-1000 no-select`}>
                        <button onClick={()=>setActiveTab('divination')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab==='divination'?'opacity-100 scale-110' : 'opacity-30'}`} style={{color: activeTab === 'divination' ? themeStyles.accent : '#64748b'}}><Icon name="Sparkles" size={26} /><span className="text-[10px] font-bold mt-1">占卜</span></button>
                        <button onClick={()=>setActiveTab('guide')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab==='guide'?'opacity-100 scale-110' : 'opacity-30'}`} style={{color: activeTab === 'guide' ? themeStyles.accent : '#64748b'}}><Icon name="BookOpen" size={26} /><span className="text-[10px] font-bold mt-1">指南</span></button>
                    </nav>

                    {isSetupVisible && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/95 backdrop-blur-md">
                            <div className="w-full max-w-sm glass-panel rounded-[3.5rem] p-10 space-y-8 shadow-2xl">
                                <div className="text-center space-y-2"><h3 className="text-2xl font-serif font-bold transition-colors duration-1000">管理加密設定</h3><p className="text-[10px] opacity-50 italic text-indigo-300">完成後即可生成分享連結給親友</p></div>
                                <div className="space-y-4">
                                    <div className="space-y-1"><label className="text-[10px] opacity-40 ml-2 uppercase font-bold tracking-widest">Gemini API Key</label><input type="password" value={masterApiKey} onChange={e=>setMasterApiKey(e.target.value)} placeholder="API Key" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-indigo-400 shadow-inner" /></div>
                                    <div className="space-y-1"><label className="text-[10px] opacity-40 ml-2 uppercase font-bold tracking-widest">設定解鎖密碼</label><input type="text" value={masterPass} onChange={e=>setMasterPass(e.target.value)} placeholder="解鎖密碼" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-indigo-400 shadow-inner" /></div>
                                </div>
                                <button onClick={handleSaveMaster} className="w-full py-5 bg-white text-slate-900 rounded-full font-bold shadow-xl active:scale-95 transition-all">儲存本地設定</button>
                                <button onClick={() => setIsSetupVisible(false)} className="w-full text-[10px] opacity-30 mt-4 font-bold tracking-widest uppercase text-center">取消</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
